<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PepeCards</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS переменные для тем */
        :root {
            /* Светлая тема (по умолчанию) */
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #40a7e3;
            --tg-theme-button-text-color: #ffffff;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --accent-color: #8B5CF6;
            --accent-light: #A78BFA;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --card-back: #8B5CF6;
            --header-bg: rgba(255, 255, 255, 0.95);
            --footer-bg: #ffffff;
            --nav-bg: #ffffff;
            --nav-active: #8B5CF6;
            --nav-inactive: #a0aec0;
            
            /* Редкости */
            --rarity-common: #9ca3af;
            --rarity-rare: #3b82f6;
            --rarity-epic: #8b5cf6;
            --rarity-legendary: #f59e0b;
            --rarity-mythic: #ef4444;
            --rarity-secret: #10b981;
            
            /* Статусы */
            --cooldown-normal: #ef4444;
            --cooldown-vip: #10b981;
            --vip-gradient: linear-gradient(135deg, #f59e0b, #fbbf24);
            --pepepremium-gradient: linear-gradient(135deg, #8b5cf6, #3b82f6, #10b981);
            --rainbow: linear-gradient(90deg, #ef4444, #f59e0b, #10b981, #3b82f6, #8b5cf6);
            
            /* Админ/Премиум */
            --admin-color: #dc2626;
            --premium-color: #8b5cf6;
            
            /* Снег */
            --snow-color: rgba(255, 255, 255, 0.8);
        }

        /* Темно-фиолетовая тема */
        .theme-dark-purple {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --accent-color: #9d4edd;
            --accent-light: #c77dff;
            --border-color: #2d3748;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --card-back: #9d4edd;
            --header-bg: rgba(26, 26, 46, 0.95);
            --footer-bg: #1a1a2e;
            --nav-bg: #1a1a2e;
            --nav-active: #c77dff;
            --nav-inactive: #718096;
            --snow-color: rgba(255, 255, 255, 0.9);
        }

        /* Ночная тема */
        .theme-night {
            --bg-primary: #0a0a0f;
            --bg-secondary: #121212;
            --bg-card: #1e1e2e;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-color: #7c3aed;
            --accent-light: #a78bfa;
            --border-color: #2d3748;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --card-back: #7c3aed;
            --header-bg: rgba(10, 10, 15, 0.95);
            --footer-bg: #0a0a0f;
            --nav-bg: #0a0a0f;
            --nav-active: #a78bfa;
            --nav-inactive: #64748b;
            --snow-color: rgba(255, 255, 255, 0.9);
        }

        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        @keyframes cardReveal {
            0% { transform: scale(0.5) rotate(-15deg); opacity: 0; }
            70% { transform: scale(1.1) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }

        @keyframes rarityGlow {
            0%, 100% { box-shadow: 0 0 10px currentColor; }
            50% { box-shadow: 0 0 20px currentColor; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes confettiFall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        @keyframes progressFill {
            from { width: 0%; }
            to { width: var(--progress); }
        }

        @keyframes snowFall {
            0% { transform: translateY(-10px) translateX(0); opacity: 1; }
            100% { transform: translateY(100vh) translateX(20px); opacity: 0; }
        }

        @keyframes snowFall2 {
            0% { transform: translateY(-10px) translateX(0); opacity: 1; }
            100% { transform: translateY(100vh) translateX(-20px); opacity: 0; }
        }

        /* Снег на фоне */
        .snow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .snowflake {
            position: absolute;
            background: var(--snow-color);
            border-radius: 50%;
            pointer-events: none;
        }

        /* Общие стили */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Segoe UI Emoji', sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
            min-height: 100vh;
            padding-bottom: 70px;
            position: relative;
        }

        /* Экран загрузки */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        .loading-logo {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            animation: bounce 1s infinite;
        }

        .loading-text {
            color: white;
            font-size: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
            padding: 0 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Технический перерыв */
        .maintenance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .maintenance-content {
            background: var(--bg-card);
            padding: 30px 25px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            border: 2px solid var(--accent-color);
        }

        .maintenance-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .maintenance-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .maintenance-text {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Шапка */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--header-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 56px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .logo-icon {
            animation: bounce 2s infinite;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coins-display {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            border: 1px solid var(--border-color);
            min-width: 100px;
            justify-content: center;
        }

        .coins-display i {
            color: #f59e0b;
        }

        /* Основной контент */
        .main-content {
            margin-top: 56px;
            padding: 16px;
            animation: fadeIn 0.5s ease;
            min-height: calc(100vh - 126px);
            position: relative;
            z-index: 2;
        }

        /* Страницы */
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        /* Главная страница */
        .main-page {
            padding-top: 5px;
        }

        .greeting {
            margin-bottom: 20px;
        }

        .greeting h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: var(--accent-color);
        }

        .greeting p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .user-id {
            background: var(--bg-secondary);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 6px;
            display: inline-block;
            font-family: monospace;
        }

        .cooldown-section {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .cooldown-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-light));
        }

        .cooldown-timer {
            font-size: 2rem;
            font-weight: 800;
            text-align: center;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            color: var(--text-primary);
        }

        .cooldown-text {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .vip-badge, .premium-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-top: 8px;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .vip-badge {
            background: var(--vip-gradient);
            color: #fff;
        }

        .premium-badge {
            background: var(--pepepremium-gradient);
            color: #fff;
        }

        .open-card-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .open-card-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            color: white;
            border: none;
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .open-card-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
        }

        .open-card-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .open-card-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .rewards-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .reward-item {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .reward-icon {
            font-size: 1.5rem;
            margin-bottom: 6px;
            color: var(--accent-color);
        }

        .reward-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Админ панель */
        .admin-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid var(--admin-color);
            margin-bottom: 20px;
            position: relative;
        }

        .admin-section h2 {
            color: var(--admin-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-controls {
            display: grid;
            gap: 12px;
        }

        .admin-control-group {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px;
        }

        .admin-control-group h3 {
            font-size: 1rem;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .admin-input {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .admin-btn {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: none;
            background: var(--admin-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .admin-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .admin-btn.success {
            background: #10b981;
        }

        /* Инвентарь */
        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .inventory-header h1 {
            font-size: 1.5rem;
            color: var(--accent-color);
        }

        .total-cards {
            background: var(--bg-secondary);
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85rem;
            border: 1px solid var(--border-color);
        }

        .filters-container {
            margin-bottom: 15px;
        }

        .filters-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
        }

        .filter-btn {
            padding: 8px 14px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .filter-btn:hover {
            border-color: var(--accent-color);
        }

        .filter-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        @media (min-width: 768px) {
            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .card-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-card);
            box-shadow: 0 4px 12px var(--shadow-color);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .card-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px var(--shadow-color);
        }

        .card-item.favorite {
            border-color: #f59e0b;
        }

        .card-image {
            height: 140px;
            background-size: cover;
            background-position: center;
            background-color: var(--bg-secondary);
        }

        .card-info {
            padding: 12px;
            position: relative;
        }

        .card-name {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-rarity {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .rarity-common .card-rarity {
            background: var(--rarity-common);
            color: white;
        }

        .rarity-rare .card-rarity {
            background: var(--rarity-rare);
            color: white;
        }

        .rarity-epic .card-rarity {
            background: var(--rarity-epic);
            color: white;
        }

        .rarity-legendary .card-rarity {
            background: var(--rarity-legendary);
            color: white;
            animation: rarityGlow 2s infinite;
        }

        .rarity-mythic .card-rarity {
            background: var(--rarity-mythic);
            color: white;
            animation: rarityGlow 1.5s infinite;
        }

        .rarity-secret .card-rarity {
            background: var(--rainbow);
            background-size: 200% 200%;
            color: white;
            animation: shimmer 2s infinite linear, rarityGlow 1s infinite;
        }

        .favorite-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
            backdrop-filter: blur(5px);
        }

        .favorite-btn:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: scale(1.1);
        }

        .favorite-btn.active {
            background: #f59e0b;
            color: white;
        }

        .card-count {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 2;
            backdrop-filter: blur(5px);
        }

        /* Магазин */
        .shop-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .shop-tab {
            padding: 10px 16px;
            border-radius: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            font-size: 0.9rem;
        }

        .shop-tab:hover {
            background: var(--border-color);
        }

        .shop-tab.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .shop-items {
            display: grid;
            gap: 12px;
        }

        .shop-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .shop-item:hover {
            transform: translateY(-2px);
            border-color: var(--accent-color);
            box-shadow: 0 8px 20px var(--shadow-color);
        }

        .shop-item-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .shop-item-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            flex-shrink: 0;
        }

        .shop-item-title {
            flex: 1;
            min-width: 0;
        }

        .shop-item-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .shop-item-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .shop-item-price {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 12px;
        }

        .shop-item-btn {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .shop-item-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .shop-item-btn:active {
            transform: translateY(0);
        }

        .shop-item-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .shop-item-btn.equipped {
            background: #10b981;
        }

        /* Лидерборд */
        .leaderboard-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .leaderboard-header h1 {
            font-size: 1.5rem;
            color: var(--accent-color);
            margin-bottom: 8px;
        }

        .leaderboard-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .leaderboard-tab {
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .leaderboard-tab:hover {
            border-color: var(--accent-color);
        }

        .leaderboard-tab.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .leaderboard-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        .leaderboard-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .leaderboard-item.top-3 {
            border: 2px solid var(--accent-color);
        }

        .leaderboard-rank {
            font-size: 1.2rem;
            font-weight: 800;
            min-width: 35px;
            text-align: center;
            flex-shrink: 0;
        }

        .rank-1 .leaderboard-rank {
            color: #f59e0b;
        }

        .rank-2 .leaderboard-rank {
            color: #a0a0a0;
        }

        .rank-3 .leaderboard-rank {
            color: #cd7f32;
        }

        .leaderboard-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--bg-secondary);
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            border: 2px solid var(--accent-color);
        }

        .leaderboard-info {
            flex: 1;
            min-width: 0;
        }

        .leaderboard-name {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .username-suffix {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .leaderboard-stats {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .leaderboard-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .leaderboard-value {
            font-weight: 700;
            color: var(--accent-color);
        }

        /* Профиль */
        .profile-header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }

        .profile-avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 12px;
        }

        .profile-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: var(--bg-secondary);
            background-size: cover;
            background-position: center;
            border: 3px solid var(--accent-color);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-frame {
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border: 2px solid transparent;
            border-radius: 50%;
            pointer-events: none;
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .profile-title {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: inline-block;
        }

        .profile-id {
            background: var(--bg-secondary);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .profile-stat {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .profile-stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-color);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .level-progress {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .level-bar {
            height: 10px;
            background: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .level-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-light));
            width: 0%;
            transition: width 1s ease;
            position: relative;
            overflow: hidden;
        }

        .level-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .level-exp {
            text-align: right;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .favorite-card-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .favorite-card-section h3 {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: var(--accent-color);
        }

        .favorite-card-preview {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .favorite-card-preview:hover {
            transform: translateY(-2px);
        }

        .favorite-card-image {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            background: var(--bg-primary);
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
        }

        .favorite-card-info {
            flex: 1;
            min-width: 0;
        }

        .favorite-card-info h4 {
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .favorite-card-rarity {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
        }

        /* Кнопки доната в профиле */
        .donate-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .donate-profile-btn {
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.95rem;
        }

        .donate-coins-btn {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: white;
        }

        .donate-premium-btn {
            background: var(--pepepremium-gradient);
            color: white;
        }

        .donate-profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .donate-profile-btn:active {
            transform: translateY(0);
        }

        /* Выбор темы */
        .theme-selector {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }

        .theme-selector h3 {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: var(--accent-color);
        }

        .theme-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .theme-option {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .theme-option:hover {
            border-color: var(--accent-color);
        }

        .theme-option.active {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: white;
        }

        .theme-option i {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .theme-option span {
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Модальное окно доната */
        .donate-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .donate-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            animation: fadeIn 0.3s ease;
            border: 2px solid var(--accent-color);
            max-height: 90vh;
            overflow-y: auto;
        }

        .donate-icon {
            font-size: 2.5rem;
            color: var(--accent-color);
            margin-bottom: 15px;
        }

        .donate-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--accent-color);
        }

        .donate-text {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .donate-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .donate-option {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .donate-option:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .donate-option.selected {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, var(--bg-secondary), rgba(139, 92, 246, 0.1));
        }

        .donate-option-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .donate-option-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .donate-option-title {
            font-size: 1rem;
            font-weight: 600;
            flex: 1;
            text-align: left;
        }

        .donate-option-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-color);
        }

        .donate-option-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: left;
            line-height: 1.4;
        }

        .donate-input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .donate-input-group label {
            display: block;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 6px;
            font-weight: 600;
        }

        .donate-input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
        }

        .donate-price-display {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--accent-color);
            font-size: 1.1rem;
            border: 1px solid var(--border-color);
        }

        .donate-buttons-modal {
            display: flex;
            gap: 10px;
        }

        .donate-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .donate-btn.primary {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            color: white;
        }

        .donate-btn.primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .donate-btn.secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .donate-btn.secondary:hover {
            background: var(--border-color);
        }

        /* Мини профиль игрока */
        .mini-profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .mini-profile-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            animation: fadeIn 0.3s ease;
            border: 2px solid var(--accent-color);
            max-height: 90vh;
            overflow-y: auto;
        }

        .mini-profile-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .mini-profile-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--bg-secondary);
            background-size: cover;
            background-position: center;
            margin: 0 auto 12px;
            border: 2px solid var(--accent-color);
        }

        .mini-profile-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .mini-profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .mini-profile-stat {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .mini-profile-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 4px;
        }

        .mini-profile-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .mini-profile-favorite {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .mini-profile-favorite h4 {
            font-size: 1rem;
            margin-bottom: 12px;
            color: var(--accent-color);
        }

        .favorite-card-display {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .favorite-card-display-image {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: var(--bg-primary);
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
        }

        .favorite-card-display-info h5 {
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .favorite-card-display-rarity {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
        }

        .mini-profile-close {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: none;
            background: var(--accent-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mini-profile-close:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Анимация получения карты */
        .card-reveal-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .card-reveal-content {
            width: 100%;
            max-width: 320px;
            text-align: center;
        }

        .reveal-card {
            width: 100%;
            height: 380px;
            perspective: 1000px;
            margin-bottom: 25px;
        }

        .reveal-card-inner {
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 1s;
            position: relative;
        }

        .reveal-card.flipped .reveal-card-inner {
            transform: rotateY(180deg);
        }

        .reveal-card-back, .reveal-card-front {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            overflow: hidden;
        }

        .reveal-card-back {
            background: linear-gradient(135deg, var(--card-back), var(--accent-light));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            animation: pulse 1.5s infinite;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .reveal-card-back-logo {
            font-size: 3rem;
            margin-bottom: 15px;
            animation: float 2s infinite;
        }

        .reveal-card-back-text {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .reveal-card-front {
            background: var(--bg-card);
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            border: 3px solid var(--accent-color);
        }

        .reveal-card-image {
            height: 55%;
            background-size: cover;
            background-position: center;
            background-color: var(--bg-secondary);
        }

        .reveal-card-info {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .reveal-card-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--accent-color);
        }

        .reveal-card-rarity {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            color: white;
            margin-bottom: 12px;
        }

        .reveal-rewards {
            display: flex;
            justify-content: space-around;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .reveal-reward {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .reveal-reward-icon {
            font-size: 1.3rem;
            color: var(--accent-color);
        }

        .reveal-reward-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-color);
        }

        .reveal-reward-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Нижнее меню */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--nav-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            z-index: 1000;
            padding: 8px 16px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 70px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--nav-inactive);
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 12px;
            min-width: 50px;
        }

        .nav-item:hover {
            color: var(--nav-active);
            background: var(--bg-secondary);
        }

        .nav-item.active {
            color: var(--nav-active);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(167, 139, 250, 0.1));
        }

        .nav-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 0.65rem;
            font-weight: 600;
        }

        .nav-center {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            color: white;
            padding: 10px;
            border-radius: 50%;
            transform: translateY(-10px);
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4);
        }

        .nav-center .nav-icon {
            margin-bottom: 0;
        }

        /* Утилиты */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .text-center {
            text-align: center;
        }

        .mb-2 {
            margin-bottom: 10px;
        }

        .mb-3 {
            margin-bottom: 15px;
        }

        .mb-4 {
            margin-bottom: 20px;
        }

        .mt-2 {
            margin-top: 10px;
        }

        .mt-3 {
            margin-top: 15px;
        }

        .mt-4 {
            margin-top: 20px;
        }

        .gap-2 {
            gap: 10px;
        }

        .gap-3 {
            gap: 15px;
        }

        .gap-4 {
            gap: 20px;
        }

        .w-full {
            width: 100%;
        }

        /* Анимация для премиум статуса */
        .premium-glow {
            position: relative;
            overflow: hidden;
        }

        .premium-glow::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--pepepremium-gradient);
            border-radius: inherit;
            z-index: -1;
            animation: shimmer 2s infinite linear;
        }

        /* Улучшенные стили для карточек */
        .card-item.rarity-secret {
            position: relative;
            overflow: hidden;
        }

        .card-item.rarity-secret::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--rainbow);
            background-size: 400% 400%;
            animation: shimmer 3s infinite linear;
            opacity: 0.3;
            z-index: 1;
            pointer-events: none;
        }

        .card-item.rarity-secret .card-image {
            position: relative;
            z-index: 2;
        }

        .card-item.rarity-secret .card-info {
            position: relative;
            z-index: 2;
            background: rgba(0, 0, 0, 0.7);
            color: white;
        }

        .card-item.rarity-secret .card-name {
            color: white;
        }

        /* Адаптивность */
        @media (max-width: 480px) {
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .rewards-preview {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .profile-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .theme-options {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 360px) {
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .rewards-preview {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .leaderboard-stats {
                flex-direction: column;
                gap: 4px;
            }
        }
    </style>
</head>
<body>
    <!-- Снег на фоне -->
    <div class="snow-container" id="snowContainer"></div>

    <!-- Экран загрузки -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">🐸</div>
        <div class="loading-text">Загрузка PepeCards...</div>
        <div class="loading-spinner"></div>
    </div>

    <!-- Технический перерыв -->
    <div class="maintenance-overlay hidden" id="maintenanceOverlay">
        <div class="maintenance-content">
            <div class="maintenance-icon">🔧</div>
            <h2 class="maintenance-title">Технический перерыв</h2>
            <p class="maintenance-text">
                Мы улучшаем приложение для вас!<br>
                Возвращайтесь через несколько минут.<br>
                Приносим извинения за неудобства.
            </p>
        </div>
    </div>

    <!-- Шапка -->
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <span class="logo-icon">🐸</span>
                <span>PepeCards</span>
            </div>
        </div>
        <div class="header-right">
            <div class="coins-display">
                <i class="fas fa-coins"></i>
                <span id="headerCoins">0</span>
            </div>
            <button class="admin-btn hidden" id="adminMenuBtn" style="padding: 6px 12px; font-size: 0.8rem;">
                <i class="fas fa-shield-alt"></i>
            </button>
        </div>
    </header>

    <!-- Основной контент -->
    <main class="main-content">
        <!-- Главная страница -->
        <div class="page active" id="mainPage">
            <div class="main-page">
                <div class="greeting">
                    <h1 id="userGreeting">Привет!</h1>
                    <p id="userStatus">Начни собирать коллекцию карт</p>
                    <div class="user-id" id="userId">#0</div>
                </div>

                <div class="cooldown-section">
                    <div class="cooldown-timer" id="cooldownTimer">00:00</div>
                    <div class="cooldown-text">
                        До следующей карты
                        <div class="vip-badge hidden" id="vipBadge">VIP: 20 мин</div>
                        <div class="premium-badge hidden" id="premiumBadge">PREMIUM: 5 мин</div>
                        <div class="premium-badge" id="noLimitBadge" style="background: var(--admin-color); display: none;">NO LIMIT ❤️</div>
                    </div>
                </div>

                <div class="open-card-section">
                    <button class="open-card-btn" id="openCardBtn">
                        <i class="fas fa-gift"></i>
                        Открыть карту
                    </button>
                    
                    <div class="rewards-preview">
                        <div class="reward-item">
                            <div class="reward-icon"><i class="fas fa-coins"></i></div>
                            <div class="reward-text" id="previewCoins">30-150</div>
                        </div>
                        <div class="reward-item">
                            <div class="reward-icon"><i class="fas fa-star"></i></div>
                            <div class="reward-text" id="previewExp">30-200</div>
                        </div>
                        <div class="reward-item">
                            <div class="reward-icon"><i class="fas fa-crown"></i></div>
                            <div class="reward-text" id="previewLevel">Уровень</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Инвентарь -->
        <div class="page" id="inventoryPage">
            <div class="inventory-header">
                <h1>Инвентарь</h1>
                <div class="total-cards" id="totalCards">0 карт</div>
            </div>

            <div class="filters-container">
                <div class="filters-scroll">
                    <button class="filter-btn active" data-filter="all">Все</button>
                    <button class="filter-btn" data-filter="common">Обычные</button>
                    <button class="filter-btn" data-filter="rare">Редкие</button>
                    <button class="filter-btn" data-filter="epic">Эпические</button>
                    <button class="filter-btn" data-filter="legendary">Легендарные</button>
                    <button class="filter-btn" data-filter="mythic">Мифические</button>
                    <button class="filter-btn" data-filter="secret">Секретные</button>
                    <button class="filter-btn" data-filter="favorite">Избранные</button>
                </div>
            </div>

            <div class="cards-grid" id="cardsGrid">
                <!-- Карточки будут загружены динамически -->
            </div>
        </div>

        <!-- Магазин -->
        <div class="page" id="shopPage">
            <div class="shop-tabs">
                <button class="shop-tab active" data-tab="packs">Наборы</button>
                <button class="shop-tab" data-tab="personalization">Персонализация</button>
                <button class="shop-tab" data-tab="titles">Титулы</button>
                <button class="shop-tab" data-tab="premium">PepePremium</button>
            </div>

            <div class="shop-content">
                <!-- Наборы карт -->
                <div class="shop-items" id="packsTab">
                    <!-- Товары будут загружены динамически -->
                </div>

                <!-- Персонализация -->
                <div class="shop-items hidden" id="personalizationTab">
                    <!-- Рамки будут загружены динамически -->
                </div>

                <!-- Титулы -->
                <div class="shop-items hidden" id="titlesTab">
                    <!-- Титулы будут загружены динамически -->
                </div>

                <!-- PepePremium -->
                <div class="shop-items hidden" id="premiumTab">
                    <!-- Премиум товары будут загружены динамически -->
                </div>
            </div>
        </div>

        <!-- Лидерборд -->
        <div class="page" id="leaderboardPage">
            <div class="leaderboard-header">
                <h1>Лидерборд</h1>
                <p>Топ игроков PepeCards</p>
            </div>

            <div class="leaderboard-tabs">
                <button class="leaderboard-tab active" data-type="level">По уровню</button>
                <button class="leaderboard-tab" data-type="cards">По картам</button>
                <button class="leaderboard-tab" data-type="coins">По монетам</button>
            </div>

            <div class="leaderboard-list" id="leaderboardList">
                <!-- Игроки будут загружены динамически -->
            </div>
        </div>

        <!-- Профиль -->
        <div class="page" id="profilePage">
            <div class="profile-header">
                <div class="profile-avatar-container">
                    <div class="profile-avatar" id="profileAvatar"></div>
                    <div class="profile-frame" id="profileFrame"></div>
                </div>
                
                <div class="profile-name">
                    <span id="profileName">Игрок</span>
                    <span class="username-suffix hidden" id="usernameSuffix"></span>
                </div>
                
                <div class="profile-title" id="profileTitle">Новичок</div>
                <div class="profile-id mt-2" id="profileId">#0</div>
            </div>

            <div class="profile-stats">
                <div class="profile-stat">
                    <div class="stat-value" id="statLevel">1</div>
                    <div class="stat-label">Уровень</div>
                </div>
                <div class="profile-stat">
                    <div class="stat-value" id="statCards">0</div>
                    <div class="stat-label">Карт</div>
                </div>
                <div class="profile-stat">
                    <div class="stat-value" id="statCoins">0</div>
                    <div class="stat-label">Монет</div>
                </div>
                <div class="profile-stat">
                    <div class="stat-value" id="statUnique">0</div>
                    <div class="stat-label">Уникальных</div>
                </div>
            </div>

            <div class="level-progress">
                <div class="level-info">
                    <span>Уровень <span id="currentLevel">1</span></span>
                    <span>До <span id="nextLevel">2</span></span>
                </div>
                <div class="level-bar">
                    <div class="level-fill" id="levelFill"></div>
                </div>
                <div class="level-exp" id="levelExp">0/100 опыта</div>
            </div>

            <div class="favorite-card-section">
                <h3>Любимая карта</h3>
                <div class="favorite-card-preview" id="favoriteCardPreview">
                    <div class="favorite-card-image" id="favoriteCardImage"></div>
                    <div class="favorite-card-info">
                        <h4 id="favoriteCardName">Не выбрана</h4>
                        <div class="favorite-card-rarity" id="favoriteCardRarity"></div>
                    </div>
                </div>
            </div>

            <!-- Кнопки доната -->
            <div class="donate-buttons">
                <button class="donate-profile-btn donate-coins-btn" id="profileDonateCoinsBtn">
                    <i class="fas fa-coins"></i>
                    Купить PepeCoins
                </button>
                <button class="donate-profile-btn donate-premium-btn" id="profileDonatePremiumBtn">
                    <i class="fas fa-crown"></i>
                    PepePremium
                </button>
            </div>

            <!-- Выбор темы -->
            <div class="theme-selector">
                <h3>Выбор темы</h3>
                <div class="theme-options">
                    <div class="theme-option active" data-theme="light">
                        <i class="fas fa-sun"></i>
                        <span>Светлая</span>
                    </div>
                    <div class="theme-option" data-theme="dark-purple">
                        <i class="fas fa-moon"></i>
                        <span>Фиолетовая</span>
                    </div>
                    <div class="theme-option" data-theme="night">
                        <i class="fas fa-star"></i>
                        <span>Ночная</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Админ панель (отдельная страница) -->
        <div class="page" id="adminPage">
            <div class="admin-section">
                <h2><i class="fas fa-shield-alt"></i> Админ Панель</h2>
                <div class="admin-controls">
                    <div class="admin-control-group">
                        <h3>Поиск игрока</h3>
                        <input type="text" class="admin-input" id="adminPlayerId" placeholder="ID игрока (#123) или TG ID">
                        <button class="admin-btn" id="adminSearchBtn">Найти игрока</button>
                    </div>
                    
                    <div class="admin-control-group">
                        <h3>Текущий игрок: <span id="adminCurrentPlayer">Не выбран</span></h3>
                        <input type="number" class="admin-input" id="adminCoinsAmount" placeholder="Количество монет">
                        <button class="admin-btn success" id="adminAddCoinsBtn">Выдать монеты</button>
                        <button class="admin-btn success" id="adminAddPremiumBtn">Выдать Premium</button>
                        <button class="admin-btn" id="adminAddVipBtn">Выдать VIP</button>
                    </div>
                    
                    <div class="admin-control-group">
                        <h3>Администрирование</h3>
                        <button class="admin-btn" id="adminBanBtn">Забанить</button>
                        <button class="admin-btn" id="adminResetBtn">Сбросить профиль</button>
                        <button class="admin-btn" id="adminMaintenanceBtn">Вкл/Выкл техперерыв</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Модальное окно доната (PepeCoins) -->
    <div class="donate-modal hidden" id="donateCoinsModal">
        <div class="donate-content">
            <div class="donate-icon">💎</div>
            <h2 class="donate-title">Купить PepeCoins</h2>
            <p class="donate-text">
                Минимальная покупка: 100 PepeCoins (3 звезды)<br>
                <small>1 PepeCoin = 0.03 звезды</small>
            </p>
            
            <div class="donate-input-group">
                <label>Количество PepeCoins:</label>
                <input type="number" class="donate-input" id="donateCoinsAmount" value="100" min="100" step="100">
            </div>
            
            <div class="donate-price-display" id="donateCoinsPrice">
                100 PepeCoins = ⭐ 3
            </div>
            
            <div class="donate-options">
                <div class="donate-option selected" data-method="stars">
                    <div class="donate-option-header">
                        <div class="donate-option-icon"><i class="fas fa-star"></i></div>
                        <div class="donate-option-title">Звезды Telegram</div>
                        <div class="donate-option-price" id="starsPrice">⭐ 3</div>
                    </div>
                    <p class="donate-option-desc">Мгновенная оплата через Telegram Stars</p>
                </div>
                
                <div class="donate-option" data-method="rubles">
                    <div class="donate-option-header">
                        <div class="donate-option-icon"><i class="fas fa-ruble-sign"></i></div>
                        <div class="donate-option-title">Рубли (дешевле)</div>
                        <div class="donate-option-price" id="rublesPrice">15 ₽</div>
                    </div>
                    <p class="donate-option-desc">Написать @DefoltPlayer для оплаты</p>
                </div>
            </div>

            <div class="donate-buttons-modal">
                <button class="donate-btn secondary" id="donateCoinsCloseBtn">Отмена</button>
                <button class="donate-btn primary" id="donateCoinsConfirmBtn">Купить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно доната (PepePremium) -->
    <div class="donate-modal hidden" id="donatePremiumModal">
        <div class="donate-content">
            <div class="donate-icon">👑</div>
            <h2 class="donate-title">PepePremium</h2>
            <p class="donate-text">
                Премиум статус на 30 дней:<br>
                • Кулдаун 5 минут<br>
                • +50% монет и опыта<br>
                • Особый значок<br>
                <small>Лучшая инвестиция в вашу коллекцию!</small>
            </p>
            
            <div class="donate-options">
                <div class="donate-option selected" data-method="stars">
                    <div class="donate-option-header">
                        <div class="donate-option-icon"><i class="fas fa-star"></i></div>
                        <div class="donate-option-title">Звезды Telegram</div>
                        <div class="donate-option-price">⭐ 200</div>
                    </div>
                    <p class="donate-option-desc">Мгновенная оплата через Telegram Stars</p>
                </div>
                
                <div class="donate-option" data-method="rubles">
                    <div class="donate-option-header">
                        <div class="donate-option-icon"><i class="fas fa-ruble-sign"></i></div>
                        <div class="donate-option-title">Рубли (дешевле)</div>
                        <div class="donate-option-price">1000 ₽</div>
                    </div>
                    <p class="donate-option-desc">Написать @DefoltPlayer для оплаты</p>
                </div>
            </div>

            <div class="donate-buttons-modal">
                <button class="donate-btn secondary" id="donatePremiumCloseBtn">Отмена</button>
                <button class="donate-btn primary" id="donatePremiumConfirmBtn">Купить Premium</button>
            </div>
        </div>
    </div>

    <!-- Мини профиль игрока -->
    <div class="mini-profile-modal hidden" id="miniProfileModal">
        <div class="mini-profile-content">
            <div class="mini-profile-header">
                <div class="mini-profile-avatar" id="miniProfileAvatar"></div>
                <div class="mini-profile-name">
                    <span id="miniProfileName"></span>
                    <span class="username-suffix hidden" id="miniProfileSuffix"></span>
                </div>
            </div>
            
            <div class="mini-profile-stats">
                <div class="mini-profile-stat">
                    <div class="mini-profile-stat-value" id="miniProfileLevel"></div>
                    <div class="mini-profile-stat-label">Уровень</div>
                </div>
                <div class="mini-profile-stat">
                    <div class="mini-profile-stat-value" id="miniProfileCards"></div>
                    <div class="mini-profile-stat-label">Карт</div>
                </div>
                <div class="mini-profile-stat">
                    <div class="mini-profile-stat-value" id="miniProfileCoins"></div>
                    <div class="mini-profile-stat-label">Монет</div>
                </div>
                <div class="mini-profile-stat">
                    <div class="mini-profile-stat-value" id="miniProfileUnique"></div>
                    <div class="mini-profile-stat-label">Уникальных</div>
                </div>
            </div>

            <div class="mini-profile-favorite">
                <h4>Любимая карта</h4>
                <div class="favorite-card-display">
                    <div class="favorite-card-display-image" id="miniFavoriteCardImage"></div>
                    <div class="favorite-card-display-info">
                        <h5 id="miniFavoriteCardName">Не выбрана</h5>
                        <div class="favorite-card-display-rarity" id="miniFavoriteCardRarity"></div>
                    </div>
                </div>
            </div>

            <button class="mini-profile-close" id="miniProfileCloseBtn">Закрыть</button>
        </div>
    </div>

    <!-- Анимация получения карты -->
    <div class="card-reveal-modal hidden" id="cardRevealModal">
        <div class="card-reveal-content">
            <div class="reveal-card" id="revealCard">
                <div class="reveal-card-inner">
                    <div class="reveal-card-back">
                        <div class="reveal-card-back-logo">🐸</div>
                        <div class="reveal-card-back-text">PepeCards</div>
                    </div>
                    <div class="reveal-card-front">
                        <div class="reveal-card-image" id="revealCardImage"></div>
                        <div class="reveal-card-info">
                            <div class="reveal-card-name" id="revealCardName"></div>
                            <div class="reveal-card-rarity" id="revealCardRarity"></div>
                            
                            <div class="reveal-rewards" id="revealRewards">
                                <!-- Награды будут добавлены динамически -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Нижнее меню -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item" data-page="inventory">
            <div class="nav-icon"><i class="fas fa-box"></i></div>
            <div class="nav-label">Инвентарь</div>
        </a>
        
        <a href="#" class="nav-item" data-page="shop">
            <div class="nav-icon"><i class="fas fa-store"></i></div>
            <div class="nav-label">Магазин</div>
        </a>
        
        <a href="#" class="nav-item nav-center active" data-page="main">
            <div class="nav-icon"><i class="fas fa-home"></i></div>
            <div class="nav-label">Главная</div>
        </a>
        
        <a href="#" class="nav-item" data-page="leaderboard">
            <div class="nav-icon"><i class="fas fa-trophy"></i></div>
            <div class="nav-label">Топ</div>
        </a>
        
        <a href="#" class="nav-item" data-page="profile">
            <div class="nav-icon"><i class="fas fa-user"></i></div>
            <div class="nav-label">Профиль</div>
        </a>
    </nav>

    <script>
        // Конфигурация приложения
        const CONFIG = {
            ADMIN_ID: 6392172528,
            COOLDOWN_NORMAL: 2400, // 40 минут в секундах
            COOLDOWN_VIP: 1200, // 20 минут в секундах
            COOLDOWN_PREMIUM: 300, // 5 минут в секундах
            COOLDOWN_ADMIN: 0, // Админ без кулдауна
            
            // Карточки с обновленными наградами
            CARDS: {
                1: {
                    "id": 1,
                    "name": "Дефолтная Пепе",
                    "rarity": "common",
                    "rarityName": "Обычная",
                    "emoji": "⚪",
                    "chance": 40,
                    "min_coins": 30,
                    "max_coins": 150,
                    "min_exp": 30,
                    "max_exp": 200,
                    "image_path": "data/images/test1.jpg",
                    "description": "Стандартный Пепе, с которого начинается каждая коллекция."
                },
                2: {
                    "id": 2,
                    "name": "Клоун Пепе",
                    "rarity": "common",
                    "rarityName": "Обычная",
                    "emoji": "⚪",
                    "chance": 40,
                    "min_coins": 30,
                    "max_coins": 150,
                    "min_exp": 30,
                    "max_exp": 200,
                    "image_path": "data/images/test2.jpg",
                    "description": "Веселый клоун Пепе, который всегда поднимет настроение."
                },
                3: {
                    "id": 3,
                    "name": "Пепе В Кофте",
                    "rarity": "common",
                    "rarityName": "Обычная",
                    "emoji": "⚪",
                    "chance": 40,
                    "min_coins": 30,
                    "max_coins": 150,
                    "min_exp": 30,
                    "max_exp": 200,
                    "image_path": "data/images/test3.jpg",
                    "description": "Стильный Пепе в теплой кофте для холодных дней."
                },
                4: {
                    "id": 4,
                    "name": "Тупой Пепе",
                    "rarity": "common",
                    "rarityName": "Обычная",
                    "emoji": "⚪",
                    "chance": 40,
                    "min_coins": 30,
                    "max_coins": 150,
                    "min_exp": 30,
                    "max_exp": 200,
                    "image_path": "data/images/test4.jpg",
                    "description": "Пепе, который не всегда понимает, что происходит вокруг."
                },
                5: {
                    "id": 5,
                    "name": "Весёлый Пепе",
                    "rarity": "common",
                    "rarityName": "Обычная",
                    "emoji": "⚪",
                    "chance": 40,
                    "min_coins": 30,
                    "max_coins": 150,
                    "min_exp": 30,
                    "max_exp": 200,
                    "image_path": "data/images/test5.jpg",
                    "description": "Всегда позитивный Пепе, который видит хорошее во всем."
                },
                6: {
                    "id": 6,
                    "name": "Грустный Пепе",
                    "rarity": "common",
                    "rarityName": "Обычная",
                    "emoji": "⚪",
                    "chance": 40,
                    "min_coins": 30,
                    "max_coins": 150,
                    "min_exp": 30,
                    "max_exp": 200,
                    "image_path": "data/images/test6.jpg",
                    "description": "Пепе, который переживает не самые лучшие времена."
                },
                7: {
                    "id": 7,
                    "name": "Смеющийся Пепе",
                    "rarity": "common",
                    "rarityName": "Обычная",
                    "emoji": "⚪",
                    "chance": 40,
                    "min_coins": 30,
                    "max_coins": 150,
                    "min_exp": 30,
                    "max_exp": 200,
                    "image_path": "data/images/test7.jpg",
                    "description": "Пепе, который не может перестать смеяться над шуткой."
                },
                8: {
                    "id": 8,
                    "name": "Террорист Пепе",
                    "rarity": "common",
                    "rarityName": "Обычная",
                    "emoji": "⚪",
                    "chance": 40,
                    "min_coins": 30,
                    "max_coins": 150,
                    "min_exp": 30,
                    "max_exp": 200,
                    "image_path": "data/images/test8.jpg",
                    "description": "Пепе с опасными планами (шутка, конечно же)."
                },
                9: {
                    "id": 9,
                    "name": "Курящий Пепе",
                    "rarity": "rare",
                    "rarityName": "Редкая",
                    "emoji": "🔵",
                    "chance": 30,
                    "min_coins": 100,
                    "max_coins": 300,
                    "min_exp": 100,
                    "max_exp": 250,
                    "image_path": "data/images/test9.jpg",
                    "description": "Пепе, который любит расслабиться с сигаретой после тяжелого дня."
                },
                10: {
                    "id": 10,
                    "name": "Угашенный Пепе",
                    "rarity": "rare",
                    "rarityName": "Редкая",
                    "emoji": "🔵",
                    "chance": 30,
                    "min_coins": 100,
                    "max_coins": 300,
                    "min_exp": 100,
                    "max_exp": 250,
                    "image_path": "data/images/test10.jpg",
                    "description": "Пепе под воздействием зеленого вещества растительного происхождения."
                },
                11: {
                    "id": 11,
                    "name": "Уставший Пепе",
                    "rarity": "rare",
                    "rarityName": "Редкая",
                    "emoji": "🔵",
                    "chance": 30,
                    "min_coins": 100,
                    "max_coins": 300,
                    "min_exp": 100,
                    "max_exp": 250,
                    "image_path": "data/images/test11.jpg",
                    "description": "Пепе после тяжелого рабочего дня или бессонной ночи."
                },
                12: {
                    "id": 12,
                    "name": "Непонимающий Пепе",
                    "rarity": "rare",
                    "rarityName": "Редкая",
                    "emoji": "🔵",
                    "chance": 30,
                    "min_coins": 100,
                    "max_coins": 300,
                    "min_exp": 100,
                    "max_exp": 250,
                    "image_path": "data/images/test12.jpg",
                    "description": "Пепе, который совершенно не понимает, что происходит."
                },
                13: {
                    "id": 13,
                    "name": "Испуганный Пепе",
                    "rarity": "rare",
                    "rarityName": "Редкая",
                    "emoji": "🔵",
                    "chance": 30,
                    "min_coins": 100,
                    "max_coins": 300,
                    "min_exp": 100,
                    "max_exp": 250,
                    "image_path": "data/images/test13.jpg",
                    "description": "Пепе, который увидел нечто ужасающее."
                },
                14: {
                    "id": 14,
                    "name": "Акулёнок Пепе",
                    "rarity": "rare",
                    "rarityName": "Редкая",
                    "emoji": "🔵",
                    "chance": 30,
                    "min_coins": 100,
                    "max_coins": 300,
                    "min_exp": 100,
                    "max_exp": 250,
                    "image_path": "data/images/test14.jpg",
                    "description": "Милейший Пепе в костюме акулёнка."
                },
                15: {
                    "id": 15,
                    "name": "Пикми Пепе",
                    "rarity": "epic",
                    "rarityName": "Эпическая",
                    "emoji": "🟣",
                    "chance": 20,
                    "min_coins": 300,
                    "max_coins": 800,
                    "min_exp": 300,
                    "max_exp": 600,
                    "image_path": "data/images/test15.jpg",
                    "description": "Пепе в стиле известных инопланетных существ Пикми."
                },
                16: {
                    "id": 16,
                    "name": "Задрот Пепе",
                    "rarity": "epic",
                    "rarityName": "Эпическая",
                    "emoji": "🟣",
                    "chance": 20,
                    "min_coins": 300,
                    "max_coins": 800,
                    "min_exp": 300,
                    "max_exp": 600,
                    "image_path": "data/images/test16.jpg",
                    "description": "Пепе, который проводит все время за компьютерными играми."
                },
                17: {
                    "id": 17,
                    "name": "Бэтмэн Пепе",
                    "rarity": "epic",
                    "rarityName": "Эпическая",
                    "emoji": "🟣",
                    "chance": 20,
                    "min_coins": 300,
                    "max_coins": 800,
                    "min_exp": 300,
                    "max_exp": 600,
                    "image_path": "data/images/test17.jpg",
                    "description": "Темный рыцарь Пепе, защитник Готэма."
                },
                18: {
                    "id": 18,
                    "name": "Новогодний Пепе",
                    "rarity": "epic",
                    "rarityName": "Эпическая",
                    "emoji": "🟣",
                    "chance": 20,
                    "min_coins": 300,
                    "max_coins": 800,
                    "min_exp": 300,
                    "max_exp": 600,
                    "image_path": "data/images/test18.jpg",
                    "description": "Пепе в новогоднем настроении с подарками и гирляндами."
                },
                19: {
                    "id": 19,
                    "name": "Снайпер Пепе",
                    "rarity": "legendary",
                    "rarityName": "Легендарная",
                    "emoji": "🟡",
                    "chance": 10,
                    "min_coins": 800,
                    "max_coins": 2000,
                    "min_exp": 800,
                    "max_exp": 1500,
                    "image_path": "data/images/test19.jpg",
                    "description": "Пепе - мастер меткой стрельбы, никогда не промахивается."
                },
                20: {
                    "id": 20,
                    "name": "Таинственный Пепе",
                    "rarity": "legendary",
                    "rarityName": "Легендарная",
                    "emoji": "🟡",
                    "chance": 10,
                    "min_coins": 800,
                    "max_coins": 2000,
                    "min_exp": 800,
                    "max_exp": 1500,
                    "image_path": "data/images/test20.jpg",
                    "description": "Загадочный Пепе, окутанный тайнами и секретами."
                },
                21: {
                    "id": 21,
                    "name": "Telegram Pepe",
                    "rarity": "secret",
                    "rarityName": "Секретная",
                    "emoji": "👁️",
                    "chance": 0.1,
                    "min_coins": 15000,
                    "max_coins": 30000,
                    "min_exp": 5000,
                    "max_exp": 15000,
                    "image_path": "data/images/secret.jpg",
                    "description": "Секретная карта Пепе, связанная с мессенджером Telegram. Невероятно редкая!",
                    "secret": true
                },
                22: {
                    "id": 22,
                    "name": "Джорджи Пепе",
                    "rarity": "mythic",
                    "rarityName": "Мифическая",
                    "emoji": "🔴",
                    "chance": 3,
                    "min_coins": 1500,
                    "max_coins": 4000,
                    "min_exp": 1000,
                    "max_exp": 2500,
                    "image_path": "data/images/test22.jpg",
                    "description": "Мифический Пепе по имени Джорджи, обладающий невероятной силой."
                },
                23: {
                    "id": 23,
                    "name": "Сонный Пепе",
                    "rarity": "mythic",
                    "rarityName": "Мифическая",
                    "emoji": "🔴",
                    "chance": 3,
                    "min_coins": 1500,
                    "max_coins": 4000,
                    "min_exp": 1000,
                    "max_exp": 2500,
                    "image_path": "data/images/test23.jpg",
                    "description": "Пепе, который вечно хочет спать, но обладает мифической силой сновидений."
                },
                24: {
                    "id": 24,
                    "name": "Менеджер Пепе",
                    "rarity": "mythic",
                    "rarityName": "Мифическая",
                    "emoji": "🔴",
                    "chance": 3,
                    "min_coins": 1500,
                    "max_coins": 4000,
                    "min_exp": 1000,
                    "max_exp": 2500,
                    "image_path": "data/images/test24.jpg",
                    "description": "Пепе-менеджер, который эффективно управляет всеми процессами."
                },
                25: {
                    "id": 25,
                    "name": "Пепе Матрица",
                    "rarity": "mythic",
                    "rarityName": "Мифическая",
                    "emoji": "🔴",
                    "chance": 3,
                    "min_coins": 1500,
                    "max_coins": 4000,
                    "min_exp": 1000,
                    "max_exp": 2500,
                    "image_path": "data/images/test25.jpg",
                    "description": "Пепе, который выбрался из Матрицы и теперь видит код реальности."
                }
            },

            // Магазин
            SHOP_ITEMS: {
                packs: [
                    {
                        id: 'pack_common',
                        name: 'Обычный набор',
                        description: '3 случайные карты (обычные и выше)',
                        price: 500,
                        icon: 'fa-box',
                        type: 'pack',
                        data: { cards: 3, minRarity: 'common' }
                    },
                    {
                        id: 'pack_rare',
                        name: 'Редкий набор',
                        description: '2 карты гарантированно редкие или выше',
                        price: 800,
                        icon: 'fa-box-open',
                        type: 'pack',
                        data: { cards: 2, minRarity: 'rare' }
                    },
                    {
                        id: 'pack_epic',
                        name: 'Эпический набор',
                        description: '1 эпическая карта гарантированно',
                        price: 1500,
                        icon: 'fa-crown',
                        type: 'pack',
                        data: { cards: 1, minRarity: 'epic' }
                    },
                    {
                        id: 'pack_legendary',
                        name: 'Легендарный набор',
                        description: 'Шанс на легендарную карту',
                        price: 3000,
                        icon: 'fa-gem',
                        type: 'pack',
                        data: { cards: 1, minRarity: 'legendary' }
                    }
                ],
                
                personalization: [
                    {
                        id: 'frame_gold',
                        name: 'Золотая рамка',
                        description: 'Золотая рамка для аватара',
                        price: 1000,
                        icon: 'fa-square',
                        type: 'frame',
                        data: { color: '#f59e0b', width: '3px' }
                    },
                    {
                        id: 'frame_rainbow',
                        name: 'Радужная рамка',
                        description: 'Радужная анимированная рамка',
                        price: 2500,
                        icon: 'fa-rainbow',
                        type: 'frame',
                        data: { gradient: 'linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet)', width: '3px' }
                    },
                    {
                        id: 'frame_premium',
                        name: 'Премиум рамка',
                        description: 'Только для PepePremium',
                        price: 0,
                        icon: 'fa-crown',
                        type: 'frame',
                        data: { color: '#8b5cf6', width: '4px', premium: true }
                    }
                ],
                
                titles: [
                    {
                        id: 'title_collector',
                        name: 'Коллекционер',
                        description: 'За 10 уникальных карт',
                        price: 0,
                        icon: 'fa-layer-group',
                        type: 'title',
                        data: { requirement: 'cards', value: 10 }
                    },
                    {
                        id: 'title_master',
                        name: 'Мастер',
                        description: 'За 25 уникальных карт',
                        price: 0,
                        icon: 'fa-crown',
                        type: 'title',
                        data: { requirement: 'cards', value: 25 }
                    },
                    {
                        id: 'title_rich',
                        name: 'Богач',
                        description: 'За 5000 монет',
                        price: 0,
                        icon: 'fa-coins',
                        type: 'title',
                        data: { requirement: 'coins', value: 5000 }
                    },
                    {
                        id: 'title_millionaire',
                        name: 'Миллионер',
                        description: 'За 10000 монет',
                        price: 0,
                        icon: 'fa-gem',
                        type: 'title',
                        data: { requirement: 'coins', value: 10000 }
                    },
                    {
                        id: 'title_premium',
                        name: 'Premium',
                        description: 'Только для PepePremium',
                        price: 0,
                        icon: 'fa-crown',
                        type: 'title',
                        data: { requirement: 'premium', value: true }
                    }
                ],
                
                premium: [
                    {
                        id: 'premium_30days',
                        name: 'PepePremium 30 дней',
                        description: 'Кулдаун 5 минут, +50% наград, особый значок',
                        price: 200, // Звезды
                        icon: 'fa-crown',
                        type: 'premium',
                        data: { days: 30 }
                    }
                ]
            },

            // Титулы для уровней
            LEVEL_TITLES: {
                1: "Новичок",
                5: "Коллекционер",
                10: "Мастер",
                15: "Эксперт",
                20: "Профи",
                25: "Ветеран",
                30: "Легенда",
                35: "Магистр",
                40: "Грандмастер",
                45: "Чемпион",
                50: "PepeLegend"
            }
        };

        // Состояние приложения
        let appState = {
            // Данные текущего пользователя
            user: null,
            telegramData: null,
            
            // Статистика
            coins: 0,
            exp: 0,
            level: 1,
            expToNextLevel: 100,
            
            // Карты
            cards: [],
            favoriteCard: null,
            
            // Персонализация
            equippedSuffix: null,
            equippedFrame: null,
            equippedTitle: null,
            
            // Статусы
            isVIP: false,
            vipUntil: null,
            isPremium: false,
            premiumUntil: null,
            
            // Временные метки
            lastCardTime: 0,
            registrationDate: null,
            
            // Админ статус
            isAdmin: false,
            
            // Тема
            theme: 'light',
            
            // Админ: выбранный игрок
            adminSelectedPlayer: null
        };

        // Глобальные переменные
        let telegram = null;
        let currentPage = 'main';
        let maintenanceMode = localStorage.getItem('pepecards_maintenance') === 'true';
        let userCount = parseInt(localStorage.getItem('pepecards_user_count') || '0');
        let currentPlayerId = null;

        // DOM элементы
        const loadingScreen = document.getElementById('loadingScreen');
        const maintenanceOverlay = document.getElementById('maintenanceOverlay');
        const headerCoins = document.getElementById('headerCoins');
        const userGreeting = document.getElementById('userGreeting');
        const userStatus = document.getElementById('userStatus');
        const userId = document.getElementById('userId');
        const cooldownTimer = document.getElementById('cooldownTimer');
        const vipBadge = document.getElementById('vipBadge');
        const premiumBadge = document.getElementById('premiumBadge');
        const noLimitBadge = document.getElementById('noLimitBadge');
        const openCardBtn = document.getElementById('openCardBtn');
        const previewCoins = document.getElementById('previewCoins');
        const previewExp = document.getElementById('previewExp');
        const previewLevel = document.getElementById('previewLevel');
        const adminMenuBtn = document.getElementById('adminMenuBtn');
        
        // Инвентарь
        const totalCards = document.getElementById('totalCards');
        const cardsGrid = document.getElementById('cardsGrid');
        const filterBtns = document.querySelectorAll('.filter-btn');
        
        // Профиль
        const profileAvatar = document.getElementById('profileAvatar');
        const profileFrame = document.getElementById('profileFrame');
        const profileName = document.getElementById('profileName');
        const usernameSuffix = document.getElementById('usernameSuffix');
        const profileTitle = document.getElementById('profileTitle');
        const profileId = document.getElementById('profileId');
        const statLevel = document.getElementById('statLevel');
        const statCards = document.getElementById('statCards');
        const statCoins = document.getElementById('statCoins');
        const statUnique = document.getElementById('statUnique');
        const currentLevel = document.getElementById('currentLevel');
        const nextLevel = document.getElementById('nextLevel');
        const levelFill = document.getElementById('levelFill');
        const levelExp = document.getElementById('levelExp');
        const favoriteCardPreview = document.getElementById('favoriteCardPreview');
        const favoriteCardImage = document.getElementById('favoriteCardImage');
        const favoriteCardName = document.getElementById('favoriteCardName');
        const favoriteCardRarity = document.getElementById('favoriteCardRarity');
        const profileDonateCoinsBtn = document.getElementById('profileDonateCoinsBtn');
        const profileDonatePremiumBtn = document.getElementById('profileDonatePremiumBtn');
        const themeOptions = document.querySelectorAll('.theme-option');
        
        // Модалки
        const donateCoinsModal = document.getElementById('donateCoinsModal');
        const donateCoinsCloseBtn = document.getElementById('donateCoinsCloseBtn');
        const donateCoinsConfirmBtn = document.getElementById('donateCoinsConfirmBtn');
        const donateCoinsAmount = document.getElementById('donateCoinsAmount');
        const donateCoinsPrice = document.getElementById('donateCoinsPrice');
        const starsPrice = document.getElementById('starsPrice');
        const rublesPrice = document.getElementById('rublesPrice');
        
        const donatePremiumModal = document.getElementById('donatePremiumModal');
        const donatePremiumCloseBtn = document.getElementById('donatePremiumCloseBtn');
        const donatePremiumConfirmBtn = document.getElementById('donatePremiumConfirmBtn');
        
        const donateOptions = document.querySelectorAll('.donate-option');
        
        const miniProfileModal = document.getElementById('miniProfileModal');
        const miniProfileCloseBtn = document.getElementById('miniProfileCloseBtn');
        
        const cardRevealModal = document.getElementById('cardRevealModal');
        const revealCard = document.getElementById('revealCard');
        const revealCardImage = document.getElementById('revealCardImage');
        const revealCardName = document.getElementById('revealCardName');
        const revealCardRarity = document.getElementById('revealCardRarity');
        const revealRewards = document.getElementById('revealRewards');
        
        // Навигация
        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.nav-item');
        
        // Админ элементы
        const adminPlayerId = document.getElementById('adminPlayerId');
        const adminSearchBtn = document.getElementById('adminSearchBtn');
        const adminCurrentPlayer = document.getElementById('adminCurrentPlayer');
        const adminCoinsAmount = document.getElementById('adminCoinsAmount');
        const adminAddCoinsBtn = document.getElementById('adminAddCoinsBtn');
        const adminAddPremiumBtn = document.getElementById('adminAddPremiumBtn');
        const adminAddVipBtn = document.getElementById('adminAddVipBtn');
        const adminBanBtn = document.getElementById('adminBanBtn');
        const adminResetBtn = document.getElementById('adminResetBtn');
        const adminMaintenanceBtn = document.getElementById('adminMaintenanceBtn');

        // Инициализация приложения
        async function initApp() {
            try {
                // Инициализация Telegram Web App
                telegram = window.Telegram.WebApp;
                telegram.ready();
                telegram.expand();
                
                // Получаем данные пользователя
                const user = telegram.initDataUnsafe.user;
                
                // Загружаем или создаем профиль
                await loadOrCreateProfile(user);
                
                // Настройка темы
                setupTheme();
                
                // Создаем снег
                createSnow();
                
                // Настройка обработчиков событий
                setupEventListeners();
                
                // Обновляем UI
                updateUI();
                updateInventory();
                updateShop();
                
                // Запускаем таймеры
                updateCooldown();
                setInterval(updateCooldown, 1000);
                
                // Проверяем технический перерыв
                if (maintenanceMode && !appState.isAdmin) {
                    maintenanceOverlay.classList.remove('hidden');
                }
                
                // Скрываем экран загрузки
                setTimeout(() => {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                    }, 300);
                }, 1000);
                
                // Приветственное сообщение
                setTimeout(() => {
                    showNotification(`Добро пожаловать, ${user.first_name}! 🐸`);
                }, 1500);
                
            } catch (error) {
                console.error('Ошибка инициализации:', error);
                showNotification('Ошибка загрузки приложения');
                loadingScreen.querySelector('.loading-text').textContent = 'Ошибка загрузки. Обновите страницу.';
            }
        }

        // Создание снега
        function createSnow() {
            const snowContainer = document.getElementById('snowContainer');
            const snowflakeCount = 50;
            
            for (let i = 0; i < snowflakeCount; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                
                const size = Math.random() * 4 + 2;
                snowflake.style.width = `${size}px`;
                snowflake.style.height = `${size}px`;
                snowflake.style.left = `${Math.random() * 100}%`;
                snowflake.style.animation = `snowFall ${Math.random() * 5 + 5}s linear infinite`;
                snowflake.style.animationDelay = `${Math.random() * 5}s`;
                snowflake.style.opacity = Math.random() * 0.5 + 0.3;
                
                if (i % 2 === 0) {
                    snowflake.style.animationName = 'snowFall2';
                }
                
                snowContainer.appendChild(snowflake);
            }
        }

        // Загрузка или создание профиля
        async function loadOrCreateProfile(user) {
            const userId = `pepecards_user_${user.id}`;
            const savedProfile = localStorage.getItem(userId);
            
            if (savedProfile) {
                // Загружаем существующий профиль
                appState = JSON.parse(savedProfile);
                appState.user = user;
                appState.telegramData = telegram.initDataUnsafe;
                
                // Генерируем ID если его нет
                if (!appState.playerId) {
                    userCount++;
                    appState.playerId = userCount;
                    localStorage.setItem('pepecards_user_count', userCount.toString());
                }
                currentPlayerId = appState.playerId;
                
                // Проверяем актуальность VIP/Premium
                const now = new Date();
                if (appState.vipUntil && new Date(appState.vipUntil) < now) {
                    appState.isVIP = false;
                    appState.vipUntil = null;
                }
                if (appState.premiumUntil && new Date(appState.premiumUntil) < now) {
                    appState.isPremium = false;
                    appState.premiumUntil = null;
                }
            } else {
                // Создаем новый профиль
                userCount++;
                currentPlayerId = userCount;
                localStorage.setItem('pepecards_user_count', userCount.toString());
                
                appState = {
                    user: user,
                    telegramData: telegram.initDataUnsafe,
                    playerId: currentPlayerId,
                    coins: 100,
                    exp: 0,
                    level: 1,
                    expToNextLevel: 100,
                    cards: [],
                    favoriteCard: null,
                    equippedSuffix: null,
                    equippedFrame: null,
                    equippedTitle: 'Новичок',
                    isVIP: false,
                    vipUntil: null,
                    isPremium: false,
                    premiumUntil: null,
                    lastCardTime: 0,
                    registrationDate: new Date().toISOString(),
                    isAdmin: user.id === CONFIG.ADMIN_ID,
                    theme: 'light'
                };
            }
            
            // Загружаем сохраненную тему
            const savedTheme = localStorage.getItem('pepecards_theme');
            if (savedTheme) {
                appState.theme = savedTheme;
            }
            
            // Сохраняем профиль
            saveProfile();
        }

        // Сохранение профиля
        function saveProfile() {
            if (!appState.user) return;
            
            const userId = `pepecards_user_${appState.user.id}`;
            localStorage.setItem(userId, JSON.stringify(appState));
        }

        // Настройка темы
        function setupTheme() {
            // Применяем сохраненную тему
            document.body.classList.remove('theme-dark-purple', 'theme-night');
            if (appState.theme === 'dark-purple') {
                document.body.classList.add('theme-dark-purple');
            } else if (appState.theme === 'night') {
                document.body.classList.add('theme-night');
            }
            
            // Обновляем активную опцию
            themeOptions.forEach(option => {
                option.classList.remove('active');
                if (option.dataset.theme === appState.theme) {
                    option.classList.add('active');
                }
            });
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Навигация
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.dataset.page;
                    switchPage(page);
                });
            });

            // Кнопка открытия карты
            openCardBtn.addEventListener('click', openRandomCard);

            // Кнопки доната в профиле
            profileDonateCoinsBtn.addEventListener('click', () => {
                donateCoinsModal.classList.remove('hidden');
                updateDonatePrices();
            });
            
            profileDonatePremiumBtn.addEventListener('click', () => {
                donatePremiumModal.classList.remove('hidden');
            });

            // Донат модалки
            donateCoinsCloseBtn.addEventListener('click', () => {
                donateCoinsModal.classList.add('hidden');
            });

            donateCoinsConfirmBtn.addEventListener('click', processCoinsDonation);
            
            donateCoinsAmount.addEventListener('input', updateDonatePrices);

            donatePremiumCloseBtn.addEventListener('click', () => {
                donatePremiumModal.classList.add('hidden');
            });

            donatePremiumConfirmBtn.addEventListener('click', processPremiumDonation);

            donateOptions.forEach(option => {
                option.addEventListener('click', () => {
                    donateOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });

            // Мини профиль
            miniProfileCloseBtn.addEventListener('click', () => {
                miniProfileModal.classList.add('hidden');
            });

            // Фильтры инвентаря
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateInventory(btn.dataset.filter);
                });
            });

            // Предпросмотр любимой карты
            favoriteCardPreview.addEventListener('click', () => {
                if (appState.cards.length > 0) {
                    showFavoriteCardSelector();
                } else {
                    showNotification('У вас нет карт для выбора');
                }
            });

            // Выбор темы
            themeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    appState.theme = option.dataset.theme;
                    localStorage.setItem('pepecards_theme', appState.theme);
                    setupTheme();
                    saveProfile();
                    showNotification(`Тема изменена на "${option.querySelector('span').textContent}"`);
                });
            });

            // Админ меню
            adminMenuBtn.addEventListener('click', () => {
                if (appState.isAdmin) {
                    switchPage('admin');
                }
            });

            // Админ панель
            if (appState.isAdmin) {
                adminMenuBtn.classList.remove('hidden');
                
                adminSearchBtn.addEventListener('click', searchPlayer);
                adminAddCoinsBtn.addEventListener('click', addCoinsToPlayer);
                adminAddPremiumBtn.addEventListener('click', addPremiumToPlayer);
                adminAddVipBtn.addEventListener('click', addVipToPlayer);
                adminBanBtn.addEventListener('click', banPlayer);
                adminResetBtn.addEventListener('click', resetPlayer);
                adminMaintenanceBtn.addEventListener('click', toggleMaintenance);
            }

            // Обработка клика вне модалок
            document.addEventListener('click', (e) => {
                if (e.target === donateCoinsModal) {
                    donateCoinsModal.classList.add('hidden');
                }
                if (e.target === donatePremiumModal) {
                    donatePremiumModal.classList.add('hidden');
                }
                if (e.target === miniProfileModal) {
                    miniProfileModal.classList.add('hidden');
                }
                if (e.target === cardRevealModal) {
                    cardRevealModal.classList.add('hidden');
                }
            });
        }

        // Обновление цен доната
        function updateDonatePrices() {
            const coins = parseInt(donateCoinsAmount.value) || 100;
            const stars = Math.ceil(coins * 0.03);
            const rubles = Math.ceil(coins * 0.15);
            
            donateCoinsPrice.textContent = `${coins} PepeCoins = ⭐ ${stars}`;
            starsPrice.textContent = `⭐ ${stars}`;
            rublesPrice.textContent = `${rubles} ₽`;
        }

        // Переключение страниц
        function switchPage(page) {
            currentPage = page;
            
            // Скрываем все страницы
            pages.forEach(p => p.classList.remove('active'));
            
            // Показываем выбранную страницу
            document.getElementById(page + 'Page').classList.add('active');
            
            // Обновляем активную кнопку меню
            navItems.forEach(item => {
                if (item.dataset.page === page) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Загружаем контент для страницы
            switch(page) {
                case 'inventory':
                    updateInventory();
                    break;
                case 'shop':
                    updateShop();
                    break;
                case 'leaderboard':
                    updateLeaderboard();
                    break;
                case 'profile':
                    updateProfile();
                    break;
                case 'admin':
                    updateAdminPanel();
                    break;
            }
        }

        // Обновление UI
        function updateUI() {
            if (!appState.user) return;
            
            // Шапка
            headerCoins.textContent = appState.coins.toLocaleString();
            
            // Приветствие
            userGreeting.textContent = `Привет, ${appState.user.first_name}!`;
            
            if (appState.isPremium) {
                userStatus.textContent = 'PepePremium активен 👑';
                userStatus.style.color = '#8b5cf6';
            } else if (appState.isVIP) {
                userStatus.textContent = 'VIP статус активен 🎖️';
                userStatus.style.color = '#f59e0b';
            } else {
                userStatus.textContent = 'Начни собирать коллекцию карт';
                userStatus.style.color = '';
            }
            
            userId.textContent = `#${currentPlayerId}`;
            
            // Бейджи
            if (appState.isAdmin) {
                noLimitBadge.style.display = 'inline-block';
                vipBadge.classList.add('hidden');
                premiumBadge.classList.add('hidden');
            } else if (appState.isPremium) {
                premiumBadge.classList.remove('hidden');
                vipBadge.classList.add('hidden');
                noLimitBadge.style.display = 'none';
            } else if (appState.isVIP) {
                vipBadge.classList.remove('hidden');
                premiumBadge.classList.add('hidden');
                noLimitBadge.style.display = 'none';
            } else {
                vipBadge.classList.add('hidden');
                premiumBadge.classList.add('hidden');
                noLimitBadge.style.display = 'none';
            }
            
            // Предпросмотр наград
            const randomCard = getRandomCardPreview();
            previewCoins.textContent = `${randomCard.min_coins}-${randomCard.max_coins}`;
            previewExp.textContent = `${randomCard.min_exp}-${randomCard.max_exp}`;
            previewLevel.textContent = `Уровень ${appState.level}`;
        }

        // Обновление кулдауна
        function updateCooldown() {
            if (maintenanceMode && !appState.isAdmin) {
                cooldownTimer.textContent = 'ТЕХ. ПЕРЕРЫВ';
                cooldownTimer.style.color = '#ef4444';
                openCardBtn.disabled = true;
                openCardBtn.innerHTML = '<i class="fas fa-tools"></i> Технический перерыв';
                return;
            }
            
            if (appState.isAdmin) {
                cooldownTimer.textContent = 'NO LIMIT ❤️';
                cooldownTimer.style.color = '#dc2626';
                openCardBtn.disabled = false;
                return;
            }
            
            const now = Math.floor(Date.now() / 1000);
            let cooldown;
            
            if (appState.isPremium) {
                cooldown = CONFIG.COOLDOWN_PREMIUM;
            } else if (appState.isVIP) {
                cooldown = CONFIG.COOLDOWN_VIP;
            } else {
                cooldown = CONFIG.COOLDOWN_NORMAL;
            }
            
            const timeLeft = Math.max(0, appState.lastCardTime + cooldown - now);
            
            if (timeLeft === 0) {
                cooldownTimer.textContent = 'ГОТОВО!';
                cooldownTimer.style.color = '#10b981';
                openCardBtn.disabled = false;
                openCardBtn.innerHTML = '<i class="fas fa-gift"></i> Открыть карту';
            } else {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                cooldownTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                cooldownTimer.style.color = timeLeft > 60 ? '#ef4444' : '#f59e0b';
                openCardBtn.disabled = true;
                openCardBtn.innerHTML = `<i class="fas fa-clock"></i> ${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Получение случайной карты для предпросмотра
        function getRandomCardPreview() {
            const cards = Object.values(CONFIG.CARDS);
            return cards[Math.floor(Math.random() * cards.length)];
        }

        // Открытие случайной карты
        async function openRandomCard() {
            if (maintenanceMode && !appState.isAdmin) {
                showNotification('Технический перерыв. Попробуйте позже.');
                return;
            }
            
            const now = Math.floor(Date.now() / 1000);
            
            if (!appState.isAdmin) {
                // Проверка кулдауна для обычных пользователей
                let cooldown;
                
                if (appState.isPremium) {
                    cooldown = CONFIG.COOLDOWN_PREMIUM;
                } else if (appState.isVIP) {
                    cooldown = CONFIG.COOLDOWN_VIP;
                } else {
                    cooldown = CONFIG.COOLDOWN_NORMAL;
                }
                
                if (now - appState.lastCardTime < cooldown) {
                    showNotification('Подождите перед открытием следующей карты!');
                    return;
                }
            }
            
            appState.lastCardTime = now;
            
            // Получаем случайную карту
            const card = getRandomCard();
            
            // Добавляем карту в коллекцию
            const cardCopy = { ...card, obtained: new Date().toISOString() };
            appState.cards.push(cardCopy);
            
            // Добавляем награды с учетом бонусов
            let coins = getRandomInt(card.min_coins, card.max_coins);
            let exp = getRandomInt(card.min_exp, card.max_exp);
            
            if (appState.isPremium) {
                coins = Math.floor(coins * 1.5);
                exp = Math.floor(exp * 1.5);
            }
            
            appState.coins += coins;
            appState.exp += exp;
            
            // Проверяем повышение уровня
            const leveledUp = checkLevelUp();
            
            // Сохраняем изменения
            saveProfile();
            
            // Показываем анимацию
            showCardRevealAnimation(card, coins, exp, leveledUp);
            
            // Обновляем UI
            updateUI();
            updateInventory();
            updateProfile();
            
            // Звуковое уведомление
            if (telegram && telegram.HapticFeedback) {
                telegram.HapticFeedback.impactOccurred('medium');
            }
        }

        // Получение случайной карты
        function getRandomCard() {
            // Создаем взвешенный список
            let weightedList = [];
            
            Object.values(CONFIG.CARDS).forEach(card => {
                const openedCount = appState.cards.filter(c => c.id === card.id).length;
                const chanceMultiplier = openedCount > 0 ? 0.5 : 1;
                const weight = Math.floor(card.chance * chanceMultiplier);
                
                for (let i = 0; i < weight; i++) {
                    weightedList.push(card);
                }
            });
            
            // Выбираем случайную карту
            const randomIndex = Math.floor(Math.random() * weightedList.length);
            return weightedList[randomIndex] || CONFIG.CARDS[1];
        }

        // Получение случайного числа в диапазоне
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Проверка повышения уровня
        function checkLevelUp() {
            let leveledUp = false;
            
            while (appState.exp >= appState.expToNextLevel) {
                appState.level++;
                appState.exp -= appState.expToNextLevel;
                appState.expToNextLevel = Math.floor(appState.expToNextLevel * 1.5);
                leveledUp = true;
                
                // Обновляем титул
                const newTitle = getLevelTitle(appState.level);
                if (newTitle) {
                    appState.equippedTitle = newTitle;
                }
                
                // Специальная награда за уровень
                if (appState.level % 5 === 0) {
                    const bonusCoins = appState.level * 100;
                    appState.coins += bonusCoins;
                    showNotification(`🎉 Уровень ${appState.level}! +${bonusCoins} монет!`);
                }
            }
            
            return leveledUp;
        }

        // Получение титула по уровню
        function getLevelTitle(level) {
            let title = "Новичок";
            
            for (const [lvl, ttl] of Object.entries(CONFIG.LEVEL_TITLES)) {
                if (level >= parseInt(lvl)) {
                    title = ttl;
                }
            }
            
            return title;
        }

        // Показ анимации получения карты
        function showCardRevealAnimation(card, coins, exp, leveledUp) {
            revealCardImage.style.backgroundImage = `url('${card.image_path}')`;
            revealCardName.textContent = card.name;
            revealCardRarity.textContent = card.rarityName;
            revealCardRarity.className = 'reveal-card-rarity';
            revealCardRarity.classList.add(`rarity-${card.rarity}`);
            
            // Создаем отображение наград
            revealRewards.innerHTML = `
                <div class="reveal-reward">
                    <div class="reveal-reward-icon"><i class="fas fa-coins"></i></div>
                    <div class="reveal-reward-value">+${coins.toLocaleString()}</div>
                    <div class="reveal-reward-label">Монеты</div>
                </div>
                <div class="reveal-reward">
                    <div class="reveal-reward-icon"><i class="fas fa-star"></i></div>
                    <div class="reveal-reward-value">+${exp.toLocaleString()}</div>
                    <div class="reveal-reward-label">Опыт</div>
                </div>
                ${leveledUp ? `
                <div class="reveal-reward">
                    <div class="reveal-reward-icon"><i class="fas fa-level-up-alt"></i></div>
                    <div class="reveal-reward-value">${appState.level}</div>
                    <div class="reveal-reward-label">Уровень!</div>
                </div>
                ` : ''}
            `;
            
            // Показываем модалку
            cardRevealModal.classList.remove('hidden');
            revealCard.classList.remove('flipped');
            
            // Запускаем анимацию переворота
            setTimeout(() => {
                revealCard.classList.add('flipped');
                
                // Создаем конфетти для редких карт
                if (card.rarity === 'legendary' || card.rarity === 'mythic' || card.rarity === 'secret') {
                    createConfetti();
                }
                
                // Автоматическое скрытие
                setTimeout(() => {
                    cardRevealModal.classList.add('hidden');
                    revealCard.classList.remove('flipped');
                    
                    // Показываем уведомление о новой карте
                    if (card.rarity === 'secret') {
                        showNotification('🎉 НЕВЕРОЯТНО! Вы нашли СЕКРЕТНУЮ карту! 🎉');
                    } else if (card.rarity === 'mythic') {
                        showNotification('🔥 Вы получили МИФИЧЕСКУЮ карту!');
                    } else if (card.rarity === 'legendary') {
                        showNotification('⭐ Вы получили ЛЕГЕНДАРНУЮ карту!');
                    } else {
                        showNotification(`Вы получили карту: ${card.name}`);
                    }
                }, 4000);
            }, 1000);
        }

        // Создание конфетти
        function createConfetti() {
            const colors = ['#8B5CF6', '#A78BFA', '#3B82F6', '#10B981', '#F59E0B', '#EF4444'];
            
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.top = '-20px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.borderRadius = '50%';
                confetti.style.zIndex = '2001';
                confetti.style.animation = `confettiFall ${Math.random() * 2 + 1}s linear forwards`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 2000);
            }
        }

        // Обновление инвентаря
        function updateInventory(filter = 'all') {
            if (!cardsGrid) return;
            
            // Счетчики
            const total = appState.cards.length;
            const unique = [...new Set(appState.cards.map(c => c.id))].length;
            totalCards.textContent = `${total} карт (${unique} уникальных)`;
            
            // Фильтрация карт
            let filteredCards = [...appState.cards];
            
            if (filter !== 'all') {
                if (filter === 'favorite') {
                    filteredCards = appState.cards.filter(card => 
                        appState.favoriteCard && card.id === appState.favoriteCard.id
                    );
                } else {
                    filteredCards = appState.cards.filter(card => card.rarity === filter);
                }
            }
            
            // Группировка по ID и подсчет количества
            const cardCounts = {};
            filteredCards.forEach(card => {
                if (!cardCounts[card.id]) {
                    cardCounts[card.id] = {
                        card: card,
                        count: 0
                    };
                }
                cardCounts[card.id].count++;
            });
            
            const cardGroups = Object.values(cardCounts);
            
            // Очистка и рендеринг
            cardsGrid.innerHTML = '';
            
            if (cardGroups.length === 0) {
                cardsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h3>${filter === 'favorite' ? 'Нет избранных карт' : 'Карточки не найдены'}</h3>
                        <p>${filter === 'all' ? 'Откройте первую карту!' : 'Нет карт такой редкости'}</p>
                    </div>
                `;
                return;
            }
            
            cardGroups.forEach(({ card, count }) => {
                const isFavorite = appState.favoriteCard && appState.favoriteCard.id === card.id;
                
                const cardElement = document.createElement('div');
                cardElement.className = `card-item rarity-${card.rarity}`;
                if (isFavorite) cardElement.classList.add('favorite');
                
                cardElement.innerHTML = `
                    ${count > 1 ? `<div class="card-count">×${count}</div>` : ''}
                    <button class="favorite-btn ${isFavorite ? 'active' : ''}" data-id="${card.id}">
                        <i class="fas fa-heart"></i>
                    </button>
                    <div class="card-image" style="background-image: url('${card.image_path}')"></div>
                    <div class="card-info">
                        <div class="card-name">${card.name}</div>
                        <div class="card-rarity">${card.rarityName}</div>
                    </div>
                `;
                
                // Обработчик клика на карточку
                cardElement.addEventListener('click', (e) => {
                    if (!e.target.closest('.favorite-btn')) {
                        showCardDetails(card);
                    }
                });
                
                // Обработчик для кнопки избранного
                const favoriteBtn = cardElement.querySelector('.favorite-btn');
                favoriteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFavoriteCard(card);
                });
                
                cardsGrid.appendChild(cardElement);
            });
        }

        // Показ деталей карты
        function showCardDetails(card) {
            showNotification(`${card.name} - ${card.rarityName}\n${card.description}`);
        }

        // Переключение избранной карты
        function toggleFavoriteCard(card) {
            if (appState.favoriteCard && appState.favoriteCard.id === card.id) {
                appState.favoriteCard = null;
                showNotification('Карта удалена из избранного');
            } else {
                appState.favoriteCard = card;
                showNotification('Карта добавлена в избранное');
            }
            
            saveProfile();
            updateInventory();
            updateProfile();
        }

        // Показ селектора избранной карты
        function showFavoriteCardSelector() {
            const cardList = document.createElement('div');
            cardList.style.position = 'fixed';
            cardList.style.top = '0';
            cardList.style.left = '0';
            cardList.style.width = '100%';
            cardList.style.height = '100%';
            cardList.style.background = 'rgba(0,0,0,0.95)';
            cardList.style.zIndex = '2000';
            cardList.style.padding = '20px';
            cardList.style.overflowY = 'auto';
            cardList.style.backdropFilter = 'blur(10px)';
            
            // Уникальные карты
            const uniqueCards = [];
            const seenIds = new Set();
            
            appState.cards.forEach(card => {
                if (!seenIds.has(card.id)) {
                    seenIds.add(card.id);
                    uniqueCards.push(card);
                }
            });
            
            cardList.innerHTML = `
                <div style="color: white; text-align: center; margin-bottom: 20px;">
                    <h2 style="font-size: 1.5rem; margin-bottom: 10px;">Выберите любимую карту</h2>
                    <p style="color: #a0aec0;">${uniqueCards.length} уникальных карт доступно</p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    ${uniqueCards.map(card => {
                        const isFavorite = appState.favoriteCard && appState.favoriteCard.id === card.id;
                        return `
                            <div class="card-item rarity-${card.rarity}" 
                                 style="cursor: pointer; ${isFavorite ? 'border-color: #f59e0b;' : ''}"
                                 data-id="${card.id}">
                                <div class="card-image" style="background-image: url('${card.image_path}'); height: 120px;"></div>
                                <div class="card-info">
                                    <div class="card-name">${card.name}</div>
                                    <div class="card-rarity">${card.rarityName}</div>
                                    ${isFavorite ? '<div style="color: #f59e0b; font-size: 0.8rem; margin-top: 5px;">★ Избранная</div>' : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <button style="width: 100%; padding: 15px; margin-top: 20px; background: #ef4444; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;"
                        id="closeCardSelector">
                    Закрыть
                </button>
            `;
            
            document.body.appendChild(cardList);
            
            // Обработчики выбора карт
            cardList.querySelectorAll('.card-item').forEach(item => {
                item.addEventListener('click', () => {
                    const cardId = parseInt(item.dataset.id);
                    const selectedCard = uniqueCards.find(c => c.id === cardId);
                    
                    if (selectedCard) {
                        toggleFavoriteCard(selectedCard);
                        document.body.removeChild(cardList);
                    }
                });
            });
            
            // Кнопка закрытия
            document.getElementById('closeCardSelector').addEventListener('click', () => {
                document.body.removeChild(cardList);
            });
        }

        // Обновление профиля
        function updateProfile() {
            if (!appState.user) return;
            
            // Аватар
            if (appState.user.photo_url) {
                profileAvatar.style.backgroundImage = `url('${appState.user.photo_url}')`;
                profileAvatar.innerHTML = '';
            } else {
                const colors = ['#8B5CF6', '#A78BFA', '#3B82F6', '#10B981', '#F59E0B'];
                const color = colors[appState.user.id % colors.length];
                profileAvatar.style.background = `linear-gradient(135deg, ${color}, ${color}80)`;
                profileAvatar.innerHTML = `<i class="fas fa-user" style="color: white; font-size: 1.8rem;"></i>`;
            }
            
            // Рамка профиля
            if (appState.equippedFrame) {
                if (appState.equippedFrame.data.gradient) {
                    profileFrame.style.border = `${appState.equippedFrame.data.width} solid`;
                    profileFrame.style.borderImage = appState.equippedFrame.data.gradient;
                    profileFrame.style.borderImageSlice = 1;
                } else {
                    profileFrame.style.border = `${appState.equippedFrame.data.width} solid ${appState.equippedFrame.data.color}`;
                }
            } else {
                profileFrame.style.border = 'none';
            }
            
            // Имя и суффикс
            profileName.textContent = appState.user.first_name;
            if (appState.equippedSuffix) {
                usernameSuffix.textContent = appState.equippedSuffix.data.text;
                usernameSuffix.style.background = appState.equippedSuffix.data.color;
                usernameSuffix.classList.remove('hidden');
            } else {
                usernameSuffix.classList.add('hidden');
            }
            
            // Титул
            profileTitle.textContent = appState.equippedTitle || 'Новичок';
            
            // ID
            profileId.textContent = `#${currentPlayerId}`;
            
            // Статистика
            statLevel.textContent = appState.level;
            statCards.textContent = appState.cards.length;
            statCoins.textContent = appState.coins.toLocaleString();
            statUnique.textContent = [...new Set(appState.cards.map(c => c.id))].length;
            
            // Прогресс уровня
            currentLevel.textContent = appState.level;
            nextLevel.textContent = appState.level + 1;
            
            const expPercent = Math.min(100, (appState.exp / appState.expToNextLevel) * 100);
            levelFill.style.width = `${expPercent}%`;
            levelExp.textContent = `${appState.exp}/${appState.expToNextLevel} опыта`;
            
            // Любимая карта
            if (appState.favoriteCard) {
                favoriteCardImage.style.backgroundImage = `url('${appState.favoriteCard.image_path}')`;
                favoriteCardImage.innerHTML = '';
                favoriteCardName.textContent = appState.favoriteCard.name;
                favoriteCardRarity.textContent = appState.favoriteCard.rarityName;
                favoriteCardRarity.className = 'favorite-card-rarity';
                favoriteCardRarity.classList.add(`rarity-${appState.favoriteCard.rarity}`);
            } else {
                favoriteCardImage.style.backgroundImage = '';
                favoriteCardImage.innerHTML = '<i class="fas fa-heart" style="color: var(--text-secondary); font-size: 1.8rem;"></i>';
                favoriteCardName.textContent = 'Не выбрана';
                favoriteCardRarity.textContent = '—';
                favoriteCardRarity.className = 'favorite-card-rarity';
            }
        }

        // Обновление магазина
        function updateShop() {
            const shopTabs = document.querySelectorAll('.shop-tab');
            const shopContents = {
                packs: document.getElementById('packsTab'),
                personalization: document.getElementById('personalizationTab'),
                titles: document.getElementById('titlesTab'),
                premium: document.getElementById('premiumTab')
            };
            
            // Обработчики для вкладок магазина
            shopTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    shopTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    Object.values(shopContents).forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    const tabId = tab.dataset.tab + 'Tab';
                    if (shopContents[tab.dataset.tab]) {
                        shopContents[tab.dataset.tab].classList.remove('hidden');
                        renderShopTab(tab.dataset.tab);
                    }
                });
            });
            
            // Рендерим первую вкладку
            renderShopTab('packs');
        }

        function renderShopTab(tabName) {
            const items = CONFIG.SHOP_ITEMS[tabName];
            const container = document.getElementById(tabName + 'Tab');
            
            if (!items || !container) return;
            
            container.innerHTML = items.map(item => {
                const owned = checkIfOwned(item);
                const canBuy = (appState.coins >= item.price && !owned && item.price > 0) || (item.price === 0 && owned);
                const equipped = checkIfEquipped(item);
                const canEquip = owned && !equipped;
                
                // Для Premium товаров показываем цену в звездах
                const priceDisplay = item.type === 'premium' ? `⭐ ${item.price}` : `${item.price} монет`;
                
                return `
                    <div class="shop-item" data-id="${item.id}">
                        <div class="shop-item-header">
                            <div class="shop-item-icon">
                                <i class="fas ${item.icon}"></i>
                            </div>
                            <div class="shop-item-title">
                                <div class="shop-item-name">${item.name}</div>
                                <div class="shop-item-desc">${item.description}</div>
                            </div>
                        </div>
                        
                        <div class="shop-item-price">
                            <i class="fas ${item.type === 'premium' ? 'fa-star' : 'fa-coins'}"></i>
                            ${priceDisplay}
                        </div>
                        
                        ${item.price === 0 ? `
                            <button class="shop-item-btn ${equipped ? 'equipped' : ''} ${!canEquip ? 'disabled' : ''}" 
                                    ${!canEquip ? 'disabled' : ''}
                                    onclick="buyItem('${item.id}', '${tabName}')">
                                ${owned ? (equipped ? '✓ Надето' : 'Надеть') : 'Недоступно'}
                            </button>
                        ` : `
                            <button class="shop-item-btn ${equipped ? 'equipped' : ''} ${!canBuy ? 'disabled' : ''}" 
                                    ${!canBuy ? 'disabled' : ''}
                                    onclick="buyItem('${item.id}', '${tabName}')">
                                ${owned ? (equipped ? '✓ Надето' : 'Надеть') : 'Купить'}
                            </button>
                        `}
                    </div>
                `;
            }).join('');
        }

        function checkIfOwned(item) {
            switch(item.type) {
                case 'frame':
                    return appState.coins >= item.price * 0.5 || (item.data.premium && appState.isPremium);
                case 'title':
                    return checkTitleRequirement(item);
                case 'premium':
                    return appState.isPremium;
                default:
                    return appState.coins >= item.price * 0.5;
            }
        }

        function checkIfEquipped(item) {
            switch(item.type) {
                case 'frame':
                    return appState.equippedFrame && appState.equippedFrame.id === item.id;
                case 'title':
                    return appState.equippedTitle === item.name;
                default:
                    return false;
            }
        }

        function checkTitleRequirement(item) {
            if (!item.data) return false;
            
            switch(item.data.requirement) {
                case 'cards':
                    return [...new Set(appState.cards.map(c => c.id))].length >= item.data.value;
                case 'coins':
                    return appState.coins >= item.data.value;
                case 'premium':
                    return appState.isPremium;
                default:
                    return false;
            }
        }

        // Процесс доната PepeCoins
        async function processCoinsDonation() {
            const selectedOption = donateCoinsModal.querySelector('.donate-option.selected');
            if (!selectedOption) return;
            
            const coins = parseInt(donateCoinsAmount.value) || 100;
            const method = selectedOption.dataset.method;
            const stars = Math.ceil(coins * 0.03);
            
            if (coins < 100) {
                showNotification('Минимальная покупка: 100 PepeCoins', 'error');
                return;
            }
            
            if (method === 'stars') {
                // Покупка через звезды Telegram
                if (telegram && telegram.showPopup) {
                    telegram.showPopup({
                        title: 'Покупка PepeCoins',
                        message: `Вы хотите купить ${coins} PepeCoins за ⭐ ${stars}?`,
                        buttons: [
                            { type: 'ok', text: 'Купить' },
                            { type: 'cancel', text: 'Отмена' }
                        ]
                    }, async (buttonId) => {
                        if (buttonId === 'ok') {
                            // Здесь должна быть интеграция с платежами Telegram Stars
                            // Временно симулируем успешную покупку
                            appState.coins += coins;
                            saveProfile();
                            updateUI();
                            updateProfile();
                            showNotification(`Вы успешно купили ${coins} PepeCoins!`, 'success');
                            donateCoinsModal.classList.add('hidden');
                            
                            // В реальном приложении здесь должен быть запрос к боту
                            // await fetch(`https://api.telegram.org/botYOUR_BOT_TOKEN/sendInvoice?chat_id=${appState.user.id}&...`);
                        }
                    });
                }
            } else if (method === 'rubles') {
                // Покупка через рублями
                telegram.showPopup({
                    title: 'Покупка через рубли',
                    message: `Напишите @DefoltPlayer для покупки ${coins} PepeCoins за ${Math.ceil(coins * 0.15)} ₽`,
                    buttons: [
                        { type: 'default', text: 'Открыть диалог' },
                        { type: 'cancel', text: 'Отмена' }
                    ]
                }, (buttonId) => {
                    if (buttonId === 'default') {
                        window.open('https://t.me/DefoltPlayer', '_blank');
                        showNotification('Напишите @DefoltPlayer для покупки PepeCoins');
                    }
                });
                donateCoinsModal.classList.add('hidden');
            }
        }

        // Процесс доната PepePremium
        async function processPremiumDonation() {
            const selectedOption = donatePremiumModal.querySelector('.donate-option.selected');
            if (!selectedOption) return;
            
            const method = selectedOption.dataset.method;
            
            if (method === 'stars') {
                // Покупка через звезды Telegram
                if (telegram && telegram.showPopup) {
                    telegram.showPopup({
                        title: 'Покупка PepePremium',
                        message: 'Вы хотите купить PepePremium на 30 дней за ⭐ 200?',
                        buttons: [
                            { type: 'ok', text: 'Купить' },
                            { type: 'cancel', text: 'Отмена' }
                        ]
                    }, async (buttonId) => {
                        if (buttonId === 'ok') {
                            // Здесь должна быть интеграция с платежами Telegram Stars
                            // Временно симулируем успешную покупку
                            const until = new Date();
                            until.setDate(until.getDate() + 30);
                            appState.isPremium = true;
                            appState.premiumUntil = until.toISOString();
                            saveProfile();
                            updateUI();
                            updateProfile();
                            showNotification('Вы успешно приобрели PepePremium на 30 дней! 👑', 'success');
                            donatePremiumModal.classList.add('hidden');
                        }
                    });
                }
            } else if (method === 'rubles') {
                // Покупка через рублями
                telegram.showPopup({
                    title: 'Покупка через рубли',
                    message: 'Напишите @DefoltPlayer для покупки PepePremium за 1000 ₽',
                    buttons: [
                        { type: 'default', text: 'Открыть диалог' },
                        { type: 'cancel', text: 'Отмена' }
                    ]
                }, (buttonId) => {
                    if (buttonId === 'default') {
                        window.open('https://t.me/DefoltPlayer', '_blank');
                        showNotification('Напишите @DefoltPlayer для покупки PepePremium');
                    }
                });
                donatePremiumModal.classList.add('hidden');
            }
        }

        // Покупка предмета в магазине
        function buyItem(itemId, category) {
            const item = CONFIG.SHOP_ITEMS[category].find(i => i.id === itemId);
            if (!item) return;
            
            // Проверка для бесплатных предметов (титулы, рамки по условиям)
            if (item.price === 0) {
                if (!checkIfOwned(item)) {
                    showNotification('Не выполнены условия для получения', 'error');
                    return;
                }
                
                if (checkIfEquipped(item)) {
                    showNotification('Этот предмет уже надет', 'info');
                    return;
                }
                
                // Надеваем предмет
                switch(item.type) {
                    case 'frame':
                        appState.equippedFrame = item;
                        showNotification(`Рамка "${item.name}" надета`, 'success');
                        break;
                    case 'title':
                        appState.equippedTitle = item.name;
                        showNotification(`Титул "${item.name}" активирован`, 'success');
                        break;
                }
                
                saveProfile();
                updateProfile();
                updateShop();
                return;
            }
            
            // Проверка для платных предметов
            if (appState.coins < item.price) {
                showNotification('Недостаточно монет', 'error');
                return;
            }
            
            if (item.type === 'title' && !checkTitleRequirement(item)) {
                showNotification('Не выполнены требования для титула', 'error');
                return;
            }
            
            // Покупка предмета
            appState.coins -= item.price;
            
            switch(item.type) {
                case 'pack':
                    openShopPack(item);
                    break;
                case 'frame':
                    appState.equippedFrame = item;
                    showNotification(`Рамка "${item.name}" куплена и надета`, 'success');
                    break;
                case 'title':
                    appState.equippedTitle = item.name;
                    showNotification(`Титул "${item.name}" получен`, 'success');
                    break;
            }
            
            saveProfile();
            updateUI();
            updateShop();
            updateProfile();
        }

        function openShopPack(packItem) {
            const cardsCount = packItem.data.cards;
            const minRarity = packItem.data.minRarity;
            
            const rarityOrder = { 'common': 1, 'rare': 2, 'epic': 3, 'legendary': 4, 'mythic': 5, 'secret': 6 };
            const minRarityValue = rarityOrder[minRarity];
            
            const availableCards = Object.values(CONFIG.CARDS).filter(card => 
                rarityOrder[card.rarity] >= minRarityValue
            );
            
            // Открываем карты
            for (let i = 0; i < cardsCount; i++) {
                const randomIndex = Math.floor(Math.random() * availableCards.length);
                const card = availableCards[randomIndex];
                
                const cardCopy = { ...card, obtained: new Date().toISOString() };
                appState.cards.push(cardCopy);
                
                // Добавляем награды
                let coins = getRandomInt(card.min_coins, card.max_coins);
                let exp = getRandomInt(card.min_exp, card.max_exp);
                
                if (appState.isPremium) {
                    coins = Math.floor(coins * 1.5);
                    exp = Math.floor(exp * 1.5);
                }
                
                appState.coins += coins;
                appState.exp += exp;
            }
            
            checkLevelUp();
            saveProfile();
            
            showNotification(`Набор "${packItem.name}" открыт! Получено ${cardsCount} карт`, 'success');
            
            if (telegram && telegram.HapticFeedback) {
                telegram.HapticFeedback.impactOccurred('heavy');
            }
        }

        // Обновление лидерборда
        function updateLeaderboard(type = 'level') {
            const leaderboardList = document.getElementById('leaderboardList');
            if (!leaderboardList) return;
            
            const allPlayers = getAllPlayers();
            const players = allPlayers.filter(player => !player.isAdmin);
            
            players.sort((a, b) => {
                switch(type) {
                    case 'level':
                        return b.level - a.level;
                    case 'cards':
                        return b.cards.length - a.cards.length;
                    case 'coins':
                        return b.coins - a.coins;
                    default:
                        return b.level - a.level;
                }
            });
            
            const topPlayers = players.slice(0, 20);
            
            leaderboardList.innerHTML = topPlayers.map((player, index) => {
                const rank = index + 1;
                const uniqueCards = [...new Set(player.cards.map(c => c.id))].length;
                
                return `
                    <div class="leaderboard-item ${rank <= 3 ? 'top-3 rank-' + rank : ''}" onclick="showPlayerMiniProfile(${player.user.id})">
                        <div class="leaderboard-rank">${rank}</div>
                        <div class="leaderboard-avatar" style="background-image: url('${player.user.photo_url || ''}')"></div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">
                                ${player.user.first_name}
                                ${player.equippedSuffix ? `<span class="username-suffix" style="background: ${player.equippedSuffix.data.color}">${player.equippedSuffix.data.text}</span>` : ''}
                            </div>
                            <div class="leaderboard-stats">
                                <div class="leaderboard-stat">
                                    <i class="fas fa-star"></i>
                                    <span class="leaderboard-value">${player.level}</span>
                                    <span>ур.</span>
                                </div>
                                <div class="leaderboard-stat">
                                    <i class="fas fa-layer-group"></i>
                                    <span class="leaderboard-value">${uniqueCards}</span>
                                    <span>карт</span>
                                </div>
                                <div class="leaderboard-stat">
                                    <i class="fas fa-coins"></i>
                                    <span class="leaderboard-value">${player.coins.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (topPlayers.length === 0) {
                leaderboardList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <i class="fas fa-trophy" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h3>Лидерборд пуст</h3>
                        <p>Будьте первым в рейтинге!</p>
                    </div>
                `;
            }
            
            document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    updateLeaderboard(tab.dataset.type);
                });
            });
        }

        function getAllPlayers() {
            const players = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('pepecards_user_')) {
                    try {
                        const playerData = JSON.parse(localStorage.getItem(key));
                        if (playerData && playerData.user) {
                            players.push(playerData);
                        }
                    } catch (e) {
                        console.error('Ошибка загрузки данных игрока:', e);
                    }
                }
            }
            
            return players;
        }

        function showPlayerMiniProfile(userId) {
            const playerKey = `pepecards_user_${userId}`;
            const playerData = JSON.parse(localStorage.getItem(playerKey));
            
            if (!playerData) {
                showNotification('Профиль игрока не найден', 'error');
                return;
            }
            
            document.getElementById('miniProfileAvatar').style.backgroundImage = 
                playerData.user.photo_url ? `url('${playerData.user.photo_url}')` : '';
            
            document.getElementById('miniProfileName').textContent = playerData.user.first_name;
            
            const suffixElement = document.getElementById('miniProfileSuffix');
            if (playerData.equippedSuffix) {
                suffixElement.textContent = playerData.equippedSuffix.data.text;
                suffixElement.style.background = playerData.equippedSuffix.data.color;
                suffixElement.classList.remove('hidden');
            } else {
                suffixElement.classList.add('hidden');
            }
            
            document.getElementById('miniProfileLevel').textContent = playerData.level;
            document.getElementById('miniProfileCards').textContent = playerData.cards.length;
            document.getElementById('miniProfileCoins').textContent = playerData.coins.toLocaleString();
            document.getElementById('miniProfileUnique').textContent = 
                [...new Set(playerData.cards.map(c => c.id))].length;
            
            const favoriteCardImage = document.getElementById('miniFavoriteCardImage');
            const favoriteCardName = document.getElementById('miniFavoriteCardName');
            const favoriteCardRarity = document.getElementById('miniFavoriteCardRarity');
            
            if (playerData.favoriteCard) {
                favoriteCardImage.style.backgroundImage = `url('${playerData.favoriteCard.image_path}')`;
                favoriteCardName.textContent = playerData.favoriteCard.name;
                favoriteCardRarity.textContent = playerData.favoriteCard.rarityName;
                favoriteCardRarity.className = 'favorite-card-display-rarity';
                favoriteCardRarity.classList.add(`rarity-${playerData.favoriteCard.rarity}`);
            } else {
                favoriteCardImage.style.backgroundImage = '';
                favoriteCardImage.innerHTML = '<i class="fas fa-heart" style="color: var(--text-secondary); font-size: 1.5rem;"></i>';
                favoriteCardName.textContent = 'Не выбрана';
                favoriteCardRarity.textContent = '—';
                favoriteCardRarity.className = 'favorite-card-display-rarity';
            }
            
            miniProfileModal.classList.remove('hidden');
        }

        // Показ уведомления
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            let icon = 'info-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'success') icon = 'check-circle';
            
            notification.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            
            notification.style.position = 'fixed';
            notification.style.top = '70px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.background = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : 'linear-gradient(135deg, var(--accent-color), var(--accent-light))';
            notification.style.color = 'white';
            notification.style.padding = '12px 20px';
            notification.style.borderRadius = '12px';
            notification.style.boxShadow = '0 5px 20px rgba(0,0,0,0.3)';
            notification.style.zIndex = '2002';
            notification.style.display = 'flex';
            notification.style.alignItems = 'center';
            notification.style.gap = '10px';
            notification.style.maxWidth = '90%';
            notification.style.animation = 'fadeIn 0.3s ease';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(-50%) translateY(-10px)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Админ функции
        function updateAdminPanel() {
            if (appState.adminSelectedPlayer) {
                adminCurrentPlayer.textContent = `#${appState.adminSelectedPlayer.playerId} (${appState.adminSelectedPlayer.user.first_name})`;
            } else {
                adminCurrentPlayer.textContent = 'Не выбран';
            }
        }

        function searchPlayer() {
            const searchId = adminPlayerId.value.trim();
            if (!searchId) {
                showNotification('Введите ID игрока', 'error');
                return;
            }
            
            let foundPlayer = null;
            
            // Поиск по ID игрока (#123)
            if (searchId.startsWith('#')) {
                const playerId = parseInt(searchId.substring(1));
                foundPlayer = findPlayerById(playerId);
            }
            // Поиск по Telegram ID
            else if (!isNaN(searchId)) {
                const telegramId = parseInt(searchId);
                foundPlayer = findPlayerByTelegramId(telegramId);
            }
            
            if (foundPlayer) {
                appState.adminSelectedPlayer = foundPlayer;
                updateAdminPanel();
                showNotification(`Игрок найден: #${foundPlayer.playerId} (${foundPlayer.user.first_name})`, 'success');
            } else {
                showNotification('Игрок не найден', 'error');
            }
        }

        function findPlayerById(playerId) {
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('pepecards_user_')) {
                    try {
                        const playerData = JSON.parse(localStorage.getItem(key));
                        if (playerData && playerData.playerId === playerId) {
                            return playerData;
                        }
                    } catch (e) {
                        console.error('Ошибка загрузки данных игрока:', e);
                    }
                }
            }
            return null;
        }

        function findPlayerByTelegramId(telegramId) {
            const playerKey = `pepecards_user_${telegramId}`;
            const playerData = JSON.parse(localStorage.getItem(playerKey));
            return playerData || null;
        }

        function addCoinsToPlayer() {
            if (!appState.adminSelectedPlayer) {
                showNotification('Сначала выберите игрока', 'error');
                return;
            }
            
            const amount = parseInt(adminCoinsAmount.value);
            if (!amount || amount <= 0) {
                showNotification('Введите корректную сумму', 'error');
                return;
            }
            
            // Обновляем данные выбранного игрока
            const playerKey = `pepecards_user_${appState.adminSelectedPlayer.user.id}`;
            appState.adminSelectedPlayer.coins += amount;
            localStorage.setItem(playerKey, JSON.stringify(appState.adminSelectedPlayer));
            
            // Если это текущий игрок, обновляем состояние
            if (appState.adminSelectedPlayer.user.id === appState.user.id) {
                appState.coins += amount;
                updateUI();
                updateProfile();
            }
            
            showNotification(`Выдано ${amount} монет игроку #${appState.adminSelectedPlayer.playerId}`, 'success');
        }

        function addPremiumToPlayer() {
            if (!appState.adminSelectedPlayer) {
                showNotification('Сначала выберите игрока', 'error');
                return;
            }
            
            const until = new Date();
            until.setDate(until.getDate() + 30);
            
            const playerKey = `pepecards_user_${appState.adminSelectedPlayer.user.id}`;
            appState.adminSelectedPlayer.isPremium = true;
            appState.adminSelectedPlayer.premiumUntil = until.toISOString();
            localStorage.setItem(playerKey, JSON.stringify(appState.adminSelectedPlayer));
            
            if (appState.adminSelectedPlayer.user.id === appState.user.id) {
                appState.isPremium = true;
                appState.premiumUntil = until.toISOString();
                updateUI();
                updateProfile();
            }
            
            showNotification(`PepePremium выдан игроку #${appState.adminSelectedPlayer.playerId} на 30 дней`, 'success');
        }

        function addVipToPlayer() {
            if (!appState.adminSelectedPlayer) {
                showNotification('Сначала выберите игрока', 'error');
                return;
            }
            
            const until = new Date();
            until.setDate(until.getDate() + 30);
            
            const playerKey = `pepecards_user_${appState.adminSelectedPlayer.user.id}`;
            appState.adminSelectedPlayer.isVIP = true;
            appState.adminSelectedPlayer.vipUntil = until.toISOString();
            localStorage.setItem(playerKey, JSON.stringify(appState.adminSelectedPlayer));
            
            if (appState.adminSelectedPlayer.user.id === appState.user.id) {
                appState.isVIP = true;
                appState.vipUntil = until.toISOString();
                updateUI();
                updateProfile();
            }
            
            showNotification(`VIP статус выдан игроку #${appState.adminSelectedPlayer.playerId} на 30 дней`, 'success');
        }

        function banPlayer() {
            if (!appState.adminSelectedPlayer) {
                showNotification('Сначала выберите игрока', 'error');
                return;
            }
            
            telegram.showPopup({
                title: 'Бан игрока',
                message: `Забанить игрока #${appState.adminSelectedPlayer.playerId} (${appState.adminSelectedPlayer.user.first_name})?`,
                buttons: [
                    { type: 'destructive', text: 'Забанить' },
                    { type: 'cancel', text: 'Отмена' }
                ]
            }, (buttonId) => {
                if (buttonId === 'destructive') {
                    showNotification('Игрок забанен', 'success');
                }
            });
        }

        function resetPlayer() {
            if (!appState.adminSelectedPlayer) {
                showNotification('Сначала выберите игрока', 'error');
                return;
            }
            
            telegram.showPopup({
                title: 'Сброс профиля',
                message: `ВСЕ данные игрока #${appState.adminSelectedPlayer.playerId} будут удалены! Вы уверены?`,
                buttons: [
                    { type: 'destructive', text: 'Сбросить' },
                    { type: 'cancel', text: 'Отмена' }
                ]
            }, (buttonId) => {
                if (buttonId === 'destructive') {
                    const playerKey = `pepecards_user_${appState.adminSelectedPlayer.user.id}`;
                    const resetData = {
                        user: appState.adminSelectedPlayer.user,
                        telegramData: appState.adminSelectedPlayer.telegramData,
                        playerId: appState.adminSelectedPlayer.playerId,
                        coins: 100,
                        exp: 0,
                        level: 1,
                        expToNextLevel: 100,
                        cards: [],
                        favoriteCard: null,
                        equippedSuffix: null,
                        equippedFrame: null,
                        equippedTitle: 'Новичок',
                        isVIP: false,
                        vipUntil: null,
                        isPremium: false,
                        premiumUntil: null,
                        lastCardTime: 0,
                        registrationDate: new Date().toISOString(),
                        isAdmin: appState.adminSelectedPlayer.user.id === CONFIG.ADMIN_ID,
                        theme: 'light'
                    };
                    
                    localStorage.setItem(playerKey, JSON.stringify(resetData));
                    
                    if (appState.adminSelectedPlayer.user.id === appState.user.id) {
                        Object.assign(appState, resetData);
                        updateUI();
                        updateInventory();
                        updateProfile();
                    }
                    
                    appState.adminSelectedPlayer = resetData;
                    updateAdminPanel();
                    
                    showNotification('Профиль сброшен', 'success');
                }
            });
        }

        function toggleMaintenance() {
            maintenanceMode = !maintenanceMode;
            localStorage.setItem('pepecards_maintenance', maintenanceMode.toString());
            
            if (maintenanceMode) {
                maintenanceOverlay.classList.remove('hidden');
                showNotification('Технический перерыв включен', 'success');
            } else {
                maintenanceOverlay.classList.add('hidden');
                showNotification('Технический перерыв выключен', 'success');
            }
        }

        // Инициализация приложения при загрузке DOM
        document.addEventListener('DOMContentLoaded', initApp);

        // Глобальные функции для использования в HTML
        window.buyItem = buyItem;
        window.showPlayerMiniProfile = showPlayerMiniProfile;
    </script>
</body>
</html>
